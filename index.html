<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus: å…¨æ–¹ä½æ„ŸçŸ¥ç³»çµ± (v6.1 UX Fix)</title>
    <!-- æ ¸å¿ƒåº« -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #0f0f0f;
            --accent: #00ff9d;      /* æ­£å¸¸/é–‹å¿ƒ */
            --secondary: #00aaff;   /* ä¸‹ä¸€æ­¥/ç”Ÿæˆ */
            --warning: #ffaa00;     /* è­¦å‘Š/åå§¿ */
            --danger: #ff3333;      /* å£“åŠ›/éŒ¯èª¤ */
            --border: #333;
            --text-main: #e0e0e0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', 'Microsoft JhengHei', monospace;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- å·¦å´ç›£æ§ --- */
        .panel-left {
            width: 320px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
            z-index: 10;
        }

        .cam-box {
            height: 200px;
            background: #000;
            border: 2px solid var(--accent);
            border-radius: 6px;
            position: relative;
            margin-bottom: 10px;
            overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* æ•¸æ“šå„€è¡¨æ¿ */
        .metrics-box {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #222;
            font-size: 0.85em;
        }
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .val { font-weight: bold; color: #888; }
        .val.active { color: var(--accent); }
        .val.warn { color: var(--warning); }
        .val.bad { color: var(--danger); }

        /* å£“åŠ›æ¢ */
        .stress-wrapper {
            margin-top: 10px;
        }
        .stress-bar-bg {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        .stress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent);
            transition: width 0.5s, background 0.5s;
        }

        /* èŠå¤©å®¤ */
        #chat-box {
            flex-grow: 1;
            background: #080808;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .msg { padding: 10px; border-radius: 8px; font-size: 0.9em; max-width: 90%; word-wrap: break-word; line-height: 1.5; }
        .msg.ai { background: #1a2a1a; border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.user { background: #004455; align-self: flex-end; }
        .msg.system { color: #666; font-size: 0.8em; text-align: center; align-self: center; padding: 0; background: none;}

        #chat-input {
            background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px; margin-top: 10px; border-radius: 4px;
        }

        /* --- å³å´ä»»å‹™ --- */
        .panel-right {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* AI ä»»å‹™å¡ç‰‡ */
        .mission-card {
            background: #151515;
            border-left: 5px solid var(--accent);
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        .mission-header { display: flex; justify-content: space-between; align-items: center; }
        .mission-title { font-size: 1.5em; margin: 0; color: white; }
        .mission-story { color: #bbb; margin-top: 10px; font-style: italic; }
        .mission-task { background: #222; padding: 10px; margin-top: 10px; border-radius: 4px; color: var(--accent); font-family: monospace; }
        
        /* ç·¨è¼¯å™¨ */
        #editor-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: filter 0.5s;
        }
        
        textarea {
            flex-grow: 1;
            background: #0c0c0c;
            color: #dcdcdc;
            border: none;
            padding: 20px;
            font-family: 'Consolas', monospace;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }

        /* åº•éƒ¨æ§åˆ¶åˆ— (Button Area) */
        .editor-footer {
            background: #1a1a1a;
            padding: 15px;
            display: flex;
            justify-content: flex-end;
            border-top: 1px solid #333;
            gap: 15px; /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
        }

        /* åŸ·è¡ŒæŒ‰éˆ• */
        .btn-run {
            background: #005533; color: #fff; border: 1px solid var(--accent);
            padding: 10px 30px; border-radius: 4px; cursor: pointer; font-weight: bold;
            font-size: 1em;
            transition: 0.2s;
        }
        .btn-run:hover { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--accent); }

        /* ä¸‹ä¸€é—œæŒ‰éˆ• (ç§»åˆ°é€™è£¡äº†!) */
        .btn-gen {
            background: #004466; color: #fff; border: 1px solid var(--secondary);
            padding: 10px 25px; border-radius: 4px; cursor: pointer; font-weight: bold;
            font-size: 1em;
            transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .btn-gen:hover { background: var(--secondary); color: #000; box-shadow: 0 0 10px var(--secondary); }

        #output {
            height: 120px;
            background: #000; color: #aaa; padding: 15px; font-family: monospace;
            border-top: 1px solid #333; white-space: pre-wrap; overflow-y: auto;
        }

        /* --- é®ç½©å±¤ (Overlay) --- */
        
        /* 1. æ²»ç™‚æ¨¡å¼ (ç´…è‰²) */
        #therapy-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.95); z-index: 999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .therapy-box {
            width: 500px; padding: 40px; background: #111;
            border: 2px solid var(--danger); border-radius: 12px; text-align: center;
            box-shadow: 0 0 50px rgba(255, 50, 50, 0.2);
        }

        /* 2. åå§¿æé†’ (é»ƒè‰²) */
        #posture-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 15, 0, 0.9); z-index: 998; /* æ¯”æ²»ç™‚ä½ä¸€é» */
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .posture-box {
            width: 400px; padding: 30px; background: #111;
            border: 2px solid var(--warning); border-radius: 12px; text-align: center;
            box-shadow: 0 0 50px rgba(255, 170, 0, 0.2);
        }

        .btn-resume {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            padding: 10px 30px; margin-top: 20px; cursor: pointer; opacity: 0; transition: 1s;
        }

    </style>
</head>
<body>

    <!-- å·¦å´ -->
    <div class="panel-left">
        <h3 style="color:var(--accent); text-align:center; margin-top:0;">NEXUS v6.1 (UX Fix)</h3>
        
        <div class="cam-box">
            <video id="video" autoplay muted playsinline></video>
        </div>

        <div class="metrics-box">
            <div class="metric-row">
                <span>è‡‰éƒ¨è¨Šè™Ÿ:</span>
                <span id="face-status" class="val">åµæ¸¬ä¸­...</span>
            </div>
            <div class="metric-row">
                <span>è¡¨æƒ…æƒ…ç·’:</span>
                <span id="emo-val" class="val">--</span>
            </div>
            <div class="metric-row">
                <span>éµç›¤/æ»‘é¼ :</span>
                <span id="activity-val" class="val">Active</span>
            </div>
            <div class="metric-row">
                <span>æ–‡å­—èªæ°£:</span>
                <span id="text-sentiment" class="val">Neutral</span>
            </div>
            
            <div class="stress-wrapper">
                <div style="display:flex; justify-content:space-between; color:gray; font-size:0.8em;">
                    <span>STRESS LEVEL</span>
                    <span id="stress-num">0%</span>
                </div>
                <div class="stress-bar-bg">
                    <div id="stress-bar" class="stress-bar"></div>
                </div>
            </div>
        </div>

        <div id="chat-box">
            <div class="msg ai">ç³»çµ±åˆå§‹åŒ–å®Œæˆã€‚å…¨æ–¹ä½æ„ŸçŸ¥æ¨¡çµ„å·²ä¸Šç·šã€‚</div>
        </div>
        <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') sendChat()">
    </div>

    <!-- å³å´ -->
    <div class="panel-right">
        
        <!-- ğŸ§˜ åå§¿/åˆ†å¿ƒ æé†’å±¤ -->
        <div id="posture-overlay">
            <div class="posture-box">
                <h1 style="color: var(--warning); margin:0; font-size: 3em;">âš ï¸</h1>
                <h2 style="color: var(--warning);">è¨Šè™Ÿä¸­æ–· (Signal Lost)</h2>
                <p style="color:#aaa; font-size:1.1em;">ç³»çµ±åµæ¸¬ä¸åˆ°æ‚¨çš„è‡‰éƒ¨ã€‚<br>è«‹èª¿æ•´åå§¿ï¼Œæˆ–æ˜¯å›åˆ°åº§ä½ä¸Šã€‚</p>
                <small style="color:#555;">(å›åˆ°é¡é ­å‰å°‡è‡ªå‹•è§£é™¤)</small>
            </div>
        </div>

        <!-- ğŸš‘ æ²»ç™‚æ¨¡å¼å±¤ -->
        <div id="therapy-overlay">
            <div class="therapy-box">
                <h2 style="color: var(--danger); margin:0;">ğŸ”¥ ç³»çµ±éç†±è­¦å‘Š</h2>
                <p style="color:#888;">åµæ¸¬åˆ°é«˜å£“/ç„¦æ…®åæ‡‰ã€‚è«‹æš«åœæ“ä½œã€‚</p>
                <hr style="border-color:#333; margin:20px 0;">
                <div id="ai-therapy-text" style="color:#eee; font-size:1.1em; min-height:60px;">AI æ­£åœ¨é€£ç·š...</div>
                <button id="btn-resume" class="btn-resume" onclick="closeTherapy()">æˆ‘æº–å‚™å¥½äº† â–¶</button>
            </div>
        </div>

        <!-- ä»»å‹™å¡ -->
        <div class="mission-card">
            <div class="mission-header">
                <h2 class="mission-title" id="m-title">Level 0: ç³»çµ±æ ¡æº–</h2>
                <!-- æŒ‰éˆ•ç§»é™¤äº† -->
            </div>
            <div class="mission-story" id="m-story">è«‹å‘ä¸»æ©Ÿç™¼é€ç¢ºèªè¨Šè™Ÿä»¥å•Ÿå‹• Python çµ‚ç«¯æ©Ÿã€‚</div>
            <div class="mission-task" id="m-task">ä»»å‹™ï¼šä½¿ç”¨ print("Ready") å°å‡ºè¨Šè™Ÿã€‚</div>
        </div>

        <!-- ç·¨è¼¯å™¨ -->
        <div id="editor-area">
            <textarea id="code" spellcheck="false" placeholder="# Python Code Here..." oninput="handleTyping()" onkeydown="handleKeyDown(event)"></textarea>
            
            <!-- åº•éƒ¨æ§åˆ¶åˆ— -->
            <div class="editor-footer">
                <button class="btn-run" onclick="runCode()">â–¶ åŸ·è¡Œä»£ç¢¼ (RUN)</button>
                <button class="btn-gen" onclick="generateNewMission()">ğŸ”„ ä¸‹ä¸€é—œ / ç”ŸæˆæŒ‘æˆ°</button>
            </div>
            
            <div id="output">ç­‰å¾…æŒ‡ä»¤...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”‘ API KEY (è«‹å¡«å…¥)
        // ==========================================
        const API_KEY = "AIzaSyA2k88qSlo4mcuWkjoLBf9Yeb-v4BXgaco"; 
        const MODEL_NAME = "gemini-2.5-flash";
        // ==========================================

        // --- è®Šæ•¸èˆ‡ç‹€æ…‹ ---
        let pyodide = null;
        let isModelLoaded = false;
        let isTherapy = false; // æ²»ç™‚æ¨¡å¼
        let isPostureWarning = false; // åå§¿è­¦å‘Šæ¨¡å¼
        
        let currentValidation = "Ready"; // éé—œé—œéµå­—

        // 1. æ„ŸçŸ¥æ•¸æ“š (Sensors)
        let stressScore = 0;
        let textNegativeScore = 0; // æ–‡å­—è² é¢åˆ†
        
        // è‡‰éƒ¨æ»‘å‹•çª—å£
        const WINDOW_SIZE = 10;
        let faceWindow = []; // å­˜ 0(æ­£å¸¸) æˆ– 1(è² é¢)
        let faceLostCount = 0; // é€£çºŒæ‰¾ä¸åˆ°è‡‰çš„æ¬¡æ•¸

        // è¡Œç‚ºè¿½è¹¤
        let lastTypingTime = Date.now();
        let mouseDist = 0;
        let backspaceCount = 0;

        // åˆå§‹åŒ–
        async function init() {
            try {
                pyodide = await loadPyodide();
                document.getElementById('output').innerText = ">>> Python Ready.";
            } catch(e) { document.getElementById('output').innerText = "Python Load Fail"; }

            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
            ]);
            isModelLoaded = true;

            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                
                // å•Ÿå‹•ç›£æ¸¬å¾ªç’°
                video.addEventListener('play', () => {
                    setInterval(senseLoop, 500); // 0.5ç§’ä¸€æ¬¡æ„ŸçŸ¥
                });

                // æ»‘é¼ ç›£è½
                document.addEventListener('mousemove', (e) => {
                    mouseDist += Math.abs(e.movementX) + Math.abs(e.movementY);
                });

            } catch(e) {
                alert("ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿï¼Œéƒ¨åˆ†åŠŸèƒ½å°‡å¤±æ•ˆã€‚");
            }
        }
        init();

        // --- ğŸ§  æ ¸å¿ƒæ„ŸçŸ¥å¾ªç’° (Omni-Sense Loop) ---
        async function senseLoop() {
            if(!isModelLoaded) return;
            if(isTherapy) return;

            const video = document.getElementById('video');
            
            // 1. è‡‰éƒ¨åµæ¸¬
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            
            // --- A. åå§¿/åˆ†å¿ƒæª¢æ¸¬ (Face Loss) ---
            if (detections.length === 0) {
                faceLostCount++;
                document.getElementById('face-status').innerText = "è¨Šè™Ÿéºå¤±";
                document.getElementById('face-status').className = "val warn";

                // é€£çºŒ 3 ç§’ (6æ¬¡ * 0.5s) æ‰¾ä¸åˆ°è‡‰ -> è§¸ç™¼è­¦å‘Š
                if (faceLostCount > 6 && !isPostureWarning) {
                    showPostureWarning(true);
                }
            } else {
                faceLostCount = 0;
                document.getElementById('face-status').innerText = "æ­£å¸¸é€£ç·š";
                document.getElementById('face-status').className = "val active";
                if (isPostureWarning) showPostureWarning(false);
            }

            if(isPostureWarning) return;

            // --- B. æƒ…ç·’åˆ†æ ---
            let isBadFace = 0;
            if(detections.length > 0) {
                const ex = detections[0].expressions;
                const sorted = Object.entries(ex).sort((a,b)=>b[1]-a[1]);
                const top = sorted[0][0];
                
                const emoEl = document.getElementById('emo-val');
                const map = {
                    'happy': {t:'é–‹å¿ƒ', c:'#00ff9d'}, 'neutral': {t:'å¹³éœ', c:'#888'},
                    'sad': {t:'æŒ«æŠ˜', c:'#ff3333'}, 'angry': {t:'ç”Ÿæ°£', c:'#ff3333'},
                    'fearful': {t:'ç·Šå¼µ', c:'orange'}
                };
                const info = map[top] || {t:top, c:'#888'};
                emoEl.innerText = info.t;
                emoEl.style.color = info.c;

                if(['sad', 'angry', 'fearful', 'disgusted'].includes(top)) isBadFace = 1;
            }
            
            faceWindow.push(isBadFace);
            if(faceWindow.length > WINDOW_SIZE) faceWindow.shift();

            // --- C. è¡Œç‚ºåˆ†æ (æ»‘é¼ /éµç›¤) ---
            analyzeBehavior();

            // --- D. è¨ˆç®—ç¸½å£“åŠ› ---
            calculateTotalStress();
        }

        function analyzeBehavior() {
            const now = Date.now();
            const idleSec = (now - lastTypingTime) / 1000;
            
            let status = "Active";
            let color = "active";
            
            if (mouseDist > 1500 && idleSec > 5) {
                status = "ç„¦æ…®æ¸¸ç§» (Jitter)";
                color = "warn";
                textNegativeScore += 2; 
            } else if (idleSec > 20) {
                status = "é–’ç½® (Idle)";
                color = "warn";
            }
            
            if (backspaceCount > 3) {
                status = "æ†¤æ€’åˆªé™¤ (Rage)";
                color = "bad";
                textNegativeScore += 5; 
            }

            mouseDist = 0;
            if(backspaceCount > 0) backspaceCount--;
            if(textNegativeScore > 0) textNegativeScore -= 0.5;

            const actEl = document.getElementById('activity-val');
            actEl.innerText = status;
            actEl.className = "val " + color;
        }

        function calculateTotalStress() {
            const badCount = faceWindow.reduce((a,b)=>a+b, 0);
            const faceStress = (badCount / faceWindow.length) * 100;
            stressScore = (faceStress * 0.5) + Math.min(100, textNegativeScore);

            const bar = document.getElementById('stress-bar');
            bar.style.width = Math.min(100, stressScore) + "%";
            document.getElementById('stress-num').innerText = Math.floor(stressScore) + "%";

            if(stressScore < 40) bar.style.background = "#00ff9d";
            else if(stressScore < 75) bar.style.background = "#ffaa00";
            else bar.style.background = "#ff3333";

            if(stressScore > 80) triggerTherapy();
        }

        function showPostureWarning(show) {
            isPostureWarning = show;
            document.getElementById('posture-overlay').style.display = show ? 'flex' : 'none';
        }

        async function triggerTherapy() {
            if(isTherapy) return;
            isTherapy = true;
            
            document.getElementById('therapy-overlay').style.display = 'flex';
            document.getElementById('editor-area').style.filter = 'blur(10px)';
            document.getElementById('btn-resume').style.opacity = '0';
            
            const aiEl = document.getElementById('ai-therapy-text');
            aiEl.innerText = "AI æ­£åœ¨åˆ†ææ‚¨çš„ç‹€æ…‹...";

            const prompt = `
            ä½¿ç”¨è€…ç›®å‰å£“åŠ›éå¤§ (Stress > 80%)ã€‚
            è«‹è¬›ä¸€å€‹éå¸¸çŸ­çš„ç¬‘è©±ï¼Œæˆ–è€…ä¸€å¥æº«æš–çš„é¼“å‹µã€‚
            ç¹é«”ä¸­æ–‡ï¼Œèªæ°£å¹½é»˜è¼•é¬†ã€‚
            `;
            const reply = await callGemini(prompt);
            
            let i=0; aiEl.innerHTML="";
            const t = setInterval(()=>{
                aiEl.innerHTML+=reply.charAt(i); i++;
                if(i>=reply.length){ clearInterval(t); document.getElementById('btn-resume').style.opacity='1'; }
            }, 50);

            stressScore = 30;
            textNegativeScore = 0;
            faceWindow = [];
        }

        function closeTherapy() {
            document.getElementById('therapy-overlay').style.display = 'none';
            document.getElementById('editor-area').style.filter = 'none';
            isTherapy = false;
        }

        function handleTyping() { lastTypingTime = Date.now(); }
        function handleKeyDown(e) { if(e.key === 'Backspace') backspaceCount += 2; }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const val = input.value;
            if(!val) return;

            addMsg('user', val);
            input.value = "";

            const negWords = ['é›£','ä¸æœƒ','ç…©','çˆ›','è¨å­','æ”¾æ£„','çœ‹ä¸æ‡‚'];
            if(negWords.some(w => val.includes(w))) {
                textNegativeScore += 30;
                document.getElementById('text-sentiment').innerText = "Negative";
                document.getElementById('text-sentiment').className = "val bad";
            } else {
                document.getElementById('text-sentiment').innerText = "Normal";
                document.getElementById('text-sentiment').className = "val";
            }

            addMsg('system', 'AI æ€è€ƒä¸­...');
            
            const code = document.getElementById('code').value;
            const prompt = `
            ä½ æ˜¯ Code Nexus çš„ AI æˆ°è¡“é¡§å•ã€‚
            å­¸ç”Ÿæ­£åœ¨è§£é¡Œï¼š${document.getElementById('m-title').innerText}
            å­¸ç”Ÿç¨‹å¼ç¢¼ï¼š${code}
            å­¸ç”Ÿè¨Šæ¯ï¼š${val}
            è«‹ç°¡çŸ­å›ç­”ã€‚å¦‚æœå­¸ç”Ÿæ„Ÿåˆ°æŒ«æŠ˜è«‹é¼“å‹µã€‚
            `;
            const reply = await callGemini(prompt);
            document.querySelector('#chat-box .msg.system').remove();
            addMsg('ai', marked.parse(reply));
        }

        async function generateNewMission() {
            const btn = document.querySelector('.btn-gen');
            btn.innerText = "ç”Ÿæˆä¸­..."; btn.disabled = true;

            const prompt = `
            ç”Ÿæˆä¸€å€‹ Python åˆå­¸è€…é¡Œç›® JSONï¼š
            {
                "title": "æ¨™é¡Œ",
                "story": "30å­—å…§çš„ç§‘å¹»æƒ…å¢ƒ",
                "task": "å…·é«”ç¨‹å¼ä»»å‹™",
                "default_code": "# code...",
                "keyword": "åŸ·è¡Œçµæœå¿…é ˆåŒ…å«çš„å­—ä¸²"
            }
            `;
            try {
                let json = await callGemini(prompt);
                json = json.replace(/```json/g,'').replace(/```/g,'').trim();
                const data = JSON.parse(json);
                
                document.getElementById('m-title').innerText = data.title;
                document.getElementById('m-story').innerText = data.story;
                document.getElementById('m-task').innerText = "ä»»å‹™: " + data.task;
                document.getElementById('code').value = data.default_code;
                currentValidation = data.keyword;
                addMsg('ai', `æ–°ä»»å‹™ï¼š${data.title}`);
            } catch(e) { addMsg('system', 'ç”Ÿæˆå¤±æ•—'); }
            
            btn.innerText = "ğŸ”„ ä¸‹ä¸€é—œ / ç”ŸæˆæŒ‘æˆ°"; btn.disabled = false;
        }

        async function runCode() {
            const out = document.getElementById('output');
            out.innerText = ">>> åŸ·è¡Œä¸­...\n";
            if(!pyodide) return;
            
            const code = document.getElementById('code').value;
            try {
                pyodide.setStdout({ batched: (s) => out.innerText += s + "\n" });
                await pyodide.runPythonAsync(code);
                
                const res = out.innerText;
                if(currentValidation && res.includes(currentValidation)) {
                    out.innerText += "\n[SYSTEM]: âœ… ä»»å‹™é”æˆï¼";
                    addMsg('ai', 'å¹¹å¾—å¥½ï¼ç›®æ¨™é”æˆã€‚å¯ä»¥æŒ‰ä¸‹æ–¹çš„ã€Œç”ŸæˆæŒ‘æˆ°ã€é€²å…¥ä¸‹ä¸€é—œã€‚');
                }
            } catch(e) { out.innerText += "\n[Error]: " + e; }
        }

        async function callGemini(text) {
            if(API_KEY.includes("è«‹åœ¨æ­¤")) return "è«‹å¡«å¯« API Key";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            try {
                const res = await fetch(url, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text }] }] })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch(e) { return "é€£ç·šéŒ¯èª¤"; }
        }

        function addMsg(role, html) {
            const div = document.createElement('div');
            div.className = `msg ${role}`; div.innerHTML = html;
            const box = document.getElementById('chat-box');
            box.appendChild(div); box.scrollTop = box.scrollHeight;
        }

    </script>
</body>
</html>
