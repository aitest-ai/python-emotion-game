<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus: AI æƒ…å¢ƒå¼å­¸ç¿’ç³»çµ± (v5.1)</title>
    <!-- å¼•å…¥æ ¸å¿ƒåº« -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #101010;
            --accent: #00ff9d; /* Cyber Green */
            --accent-dim: #005533;
            --danger: #ff3333;
            --warning: #ffcc00;
            --border: #333;
            --text: #e0e0e0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text);
            font-family: 'Segoe UI', 'Microsoft JhengHei', monospace;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- å·¦å´ç›£æ§èˆ‡èŠå¤© --- */
        .panel-left {
            width: 320px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
            z-index: 10;
        }

        .cam-box {
            height: 200px;
            background: #000;
            border: 2px solid var(--accent);
            border-radius: 6px;
            position: relative;
            margin-bottom: 10px;
            overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* æ”å½±æ©Ÿç‹€æ…‹æŒ‡ç¤ºç‡ˆ */
        .cam-indicator {
            position: absolute; top: 10px; right: 10px;
            width: 10px; height: 10px; border-radius: 50%;
            background: red; box-shadow: 0 0 5px red;
            transition: 0.3s;
        }
        .cam-indicator.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

        .status-box {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #222;
        }

        .metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; }
        .val { font-weight: bold; color: var(--accent); }
        .val.bad { color: var(--danger); }

        /* å£“åŠ›æ¢ */
        .stress-bar-bg {
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        .stress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent);
            transition: width 0.5s ease-out, background 0.5s;
        }

        /* èŠå¤©å®¤ */
        #chat-box {
            flex-grow: 1;
            background: #080808;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .msg { padding: 10px; border-radius: 8px; font-size: 0.9em; line-height: 1.5; max-width: 90%; word-wrap: break-word; }
        .msg.ai { background: #1a2a1a; border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.user { background: #004455; align-self: flex-end; }
        .msg.system { background: transparent; color: #666; font-size: 0.8em; text-align: center; align-self: center; border: none; padding: 0;}

        #chat-input {
            background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px; margin-top: 10px; border-radius: 4px; width: 100%; box-sizing: border-box;
        }

        /* --- å³å´ä»»å‹™èˆ‡ä»£ç¢¼ --- */
        .panel-right {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ä»»å‹™å¡ç‰‡ (AI å‹•æ…‹ç”Ÿæˆ) */
        .mission-card {
            background: #151515;
            border-left: 5px solid var(--accent);
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        .mission-header { display: flex; justify-content: space-between; align-items: center; }
        .mission-title { font-size: 1.5em; margin: 0; color: white; }
        .mission-story { color: #bbb; margin-top: 10px; line-height: 1.6; font-style: italic; }
        .mission-task { background: #222; padding: 10px; margin-top: 10px; border-radius: 4px; color: var(--accent); font-family: monospace; }

        .btn-gen { background: #333; color: #ddd; border: 1px solid #555; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8em; }
        .btn-gen:hover { background: #444; }

        /* ç·¨è¼¯å™¨ */
        #editor-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: filter 0.5s;
        }
        
        textarea {
            flex-grow: 1;
            background: #0c0c0c;
            color: #dcdcdc;
            border: none;
            padding: 20px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }

        .editor-footer {
            background: #1a1a1a;
            padding: 10px;
            display: flex;
            justify-content: flex-end;
            border-top: 1px solid #333;
        }

        .btn-run {
            background: var(--accent-dim);
            color: #fff;
            border: 1px solid var(--accent);
            padding: 8px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: 0.2s;
        }
        .btn-run:hover { background: var(--accent); color: #000; }

        #output {
            height: 120px;
            background: #000;
            color: #aaa;
            padding: 15px;
            font-family: monospace;
            border-top: 1px solid #333;
            white-space: pre-wrap;
            overflow-y: auto;
        }

        /* --- è¦†è“‹å±¤ï¼šå§¿å‹¢è­¦å‘Š (Posture) --- */
        #posture-overlay {
            position: absolute;
            top: 20px; left: 50%; 
            transform: translateX(-50%);
            background: rgba(255, 204, 0, 0.9);
            color: #000;
            padding: 15px 30px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1.1em;
            z-index: 500;
            display: none; /* é è¨­éš±è— */
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.4);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: translateX(-50%) scale(1.05); } 100% { opacity: 0.8; } }

        /* --- è¦†è“‹å±¤ï¼šæ²»ç™‚æ¨¡å¼ (Therapy) --- */
        #therapy-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.95);
            z-index: 999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        .therapy-box {
            width: 500px;
            padding: 40px;
            border: 2px solid var(--danger);
            border-radius: 12px;
            background: #111;
            box-shadow: 0 0 50px rgba(255, 50, 50, 0.15);
        }
        .therapy-text { font-size: 1.2em; margin: 20px 0; color: #eee; min-height: 60px; }
        
        .btn-resume {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            padding: 10px 30px; margin-top: 20px; cursor: pointer; opacity: 0; transition: 1s;
        }

    </style>
</head>
<body>

    <!-- å§¿å‹¢è­¦å‘Š (æ‡¸æµ®) -->
    <div id="posture-overlay">
        âš ï¸ åµæ¸¬ä¸åˆ°ä½¿ç”¨è€…ï¼Œè«‹åæ­£æˆ–å›åˆ°åº§ä½
    </div>

    <!-- å·¦å´é¢æ¿ -->
    <div class="panel-left">
        <h3 style="color:var(--accent); text-align:center; letter-spacing:1px; margin-top:0;">NEXUS v5.1</h3>
        
        <div class="cam-box">
            <video id="video" autoplay muted playsinline></video>
            <div id="cam-ind" class="cam-indicator"></div>
        </div>

        <div class="status-box">
            <div class="metric-row">
                <span>æƒ…ç·’ç‹€æ…‹:</span>
                <span id="emo-val" class="val">åˆå§‹åŒ–...</span>
            </div>
            <div class="metric-row">
                <span>äº’å‹•å“è³ª:</span>
                <span id="text-sentiment-val" class="val" style="color:gray;">--</span>
            </div>
            
            <div style="margin-top:10px; font-size:0.8em; color:gray;">ç²¾ç¥è² è¼‰ (Stress Level)</div>
            <div class="stress-bar-bg">
                <div id="stress-bar" class="stress-bar"></div>
            </div>
        </div>

        <div id="chat-box">
            <div class="msg ai">é§­å®¢ä½ å¥½ã€‚æˆ‘æ˜¯ä½ çš„ AI æˆ°è¡“é¡§å•ã€‚æ­£åœ¨åˆå§‹åŒ–å­¸ç¿’ç’°å¢ƒ...</div>
        </div>
        <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯... (Enter é€å‡º)" onkeypress="if(event.key==='Enter') sendChat()" autocomplete="off">
    </div>

    <!-- å³å´é¢æ¿ -->
    <div class="panel-right">
        
        <!-- æ²»ç™‚é®ç½© -->
        <div id="therapy-overlay">
            <div class="therapy-box">
                <h2 style="color: var(--danger); margin:0;">âš ï¸ ç³»çµ±éç†±è­¦å‘Š</h2>
                <p style="color:#888;">åµæ¸¬åˆ°é«˜å£“æƒ…ç·’åæ‡‰æˆ–ç„¡æ•ˆäº’å‹•ã€‚å­¸ç¿’å”å®šå·²æš«åœã€‚</p>
                <hr style="border-color:#333; margin:20px 0;">
                <div id="ai-therapy-text" class="therapy-text">AI æ­£åœ¨é€£ç·š...</div>
                <button id="btn-resume" class="btn-resume" onclick="closeTherapy()">æˆ‘æº–å‚™å¥½äº†ï¼Œç¹¼çºŒä»»å‹™ â–¶</button>
            </div>
        </div>

        <!-- ä»»å‹™å¡ç‰‡ -->
        <div class="mission-card" id="mission-card">
            <div class="mission-header">
                <h2 class="mission-title" id="m-title">Level 0: ç³»çµ±æ ¡æº–</h2>
                <button class="btn-gen" onclick="generateNewMission()">ğŸ”„ ç”Ÿæˆæ–°æŒ‘æˆ°</button>
            </div>
            <div class="mission-story" id="m-story">æˆ‘å€‘éœ€è¦ç¢ºèªä½ çš„ Python çµ‚ç«¯æ©Ÿé‹ä½œæ­£å¸¸ã€‚è«‹å‘ä¸»æ©Ÿç™¼é€è¨Šè™Ÿã€‚</div>
            <div class="mission-task" id="m-task">ä»»å‹™ï¼šè«‹ä½¿ç”¨ print("Link Start") å°å‡ºè¨Šè™Ÿã€‚</div>
        </div>

        <!-- ç·¨è¼¯å™¨ -->
        <div id="editor-wrapper">
            <textarea id="code" spellcheck="false" placeholder="# åœ¨æ­¤è¼¸å…¥ Python ä»£ç¢¼..."></textarea>
            <div class="editor-footer">
                <button class="btn-run" onclick="runPythonCode()">â–¶ åŸ·è¡Œä»£ç¢¼ (RUN)</button>
            </div>
            <div id="output">ç­‰å¾…æŒ‡ä»¤...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”‘ API KEY è¨­å®š (è«‹å‹™å¿…å¡«å¯«)
        // ==========================================
        const API_KEY = "AIzaSyA2k88qSlo4mcuWkjoLBf9Yeb-v4BXgaco"; 
        const MODEL_NAME = "gemini-2.5-flash"; 
        // ==========================================

        // --- æ ¸å¿ƒè®Šæ•¸ ---
        let pyodide = null;
        let isModelLoaded = false;
        let isTherapy = false;
        let stressScore = 0;
        let currentValidation = "Link Start"; 
        
        // æƒ…ç·’æ»‘å‹•çª—å£
        const EMO_WINDOW = 20;
        let emoHistory = [];

        // å§¿å‹¢/å­˜åœ¨æ„Ÿåµæ¸¬è®Šæ•¸
        let hasFaceBeenDetectedOnce = false; // æ˜¯å¦æ›¾ç¶“åµæ¸¬åˆ°è‡‰ (é¿å…ä¸€é–‹å§‹æ²’äººå°±ç‹‚å«)
        let faceMissingCounter = 0;          // è‡‰æ¶ˆå¤±çš„è¨ˆæ•¸å™¨
        const FACE_MISSING_THRESHOLD = 10;   // ç´„ 5 ç§’ (500ms * 10)

        // äº’å‹•å“è³ª (Text Quality)
        let textNegativeScore = 0; 
        
        // åˆå§‹åŒ–
        async function initSystem() {
            const out = document.getElementById('output');
            
            // 1. è¼‰å…¥ Pyodide
            try {
                out.innerText = ">>> è¼‰å…¥ Python æ ¸å¿ƒä¸­...";
                pyodide = await loadPyodide();
                out.innerText = ">>> Python æ ¸å¿ƒå°±ç·’ã€‚\n>>> æ­£åœ¨å•Ÿå‹•è¦–è¦ºæ¨¡çµ„...";
            } catch(e) {
                out.innerText = "Python è¼‰å…¥å¤±æ•—: " + e;
            }

            // 2. è¼‰å…¥ Face API
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
            ]);
            isModelLoaded = true;

            // 3. å•Ÿå‹• Webcam
            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                video.addEventListener('play', () => {
                    setInterval(monitorLoop, 500); // å•Ÿå‹•ä¸»ç›£æ§å¾ªç’° (0.5ç§’ä¸€æ¬¡)
                });
                out.innerText = ">>> ç³»çµ±å…¨æ•¸é‹ä½œæ­£å¸¸ã€‚\n>>> ç­‰å¾…è¼¸å…¥...";
            } catch(e) {
                out.innerText += "\n[è­¦å‘Š] ç„¡æ³•å­˜å–æ”å½±æ©Ÿã€‚";
            }
        }
        initSystem(); 

        // --- ğŸ§  ä¸»ç›£æ§å¾ªç’° (Monitor Loop) ---
        async function monitorLoop() {
            if (!isModelLoaded || isTherapy) return;

            const video = document.getElementById('video');
            // åµæ¸¬äººè‡‰èˆ‡è¡¨æƒ…
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            const camInd = document.getElementById('cam-ind');
            const postureOverlay = document.getElementById('posture-overlay');

            if (detections.length > 0) {
                // --- ç‹€æ…‹ï¼šæœ‰äºº ---
                hasFaceBeenDetectedOnce = true;
                faceMissingCounter = 0;
                camInd.classList.add('active');
                postureOverlay.style.display = 'none'; // éš±è—è­¦å‘Š
                document.getElementById('editor-wrapper').style.filter = 'none'; // æ¢å¾©æ¸…æ™°

                // åˆ†æè¡¨æƒ…
                analyzeFace(detections[0]);

            } else {
                // --- ç‹€æ…‹ï¼šç„¡äºº ---
                camInd.classList.remove('active');
                
                // åªæœ‰ç•¶ã€Œæ›¾ç¶“æœ‰äººã€ä½†ç¾åœ¨ã€Œäººä¸è¦‹äº†ã€æ‰é–‹å§‹è¨ˆæ™‚
                if (hasFaceBeenDetectedOnce) {
                    faceMissingCounter++;
                    
                    // æ›´æ–° UI é¡¯ç¤ºã€Œæ‰¾ä¸åˆ°äººã€
                    document.getElementById('emo-val').innerText = "éºå¤±è¨Šè™Ÿ...";
                    document.getElementById('emo-val').style.color = "gray";

                    // è¶…éé–¾å€¼ (ç´„ 5 ç§’)ï¼Œé¡¯ç¤ºåå§¿è­¦å‘Š
                    if (faceMissingCounter > FACE_MISSING_THRESHOLD) {
                        postureOverlay.style.display = 'block';
                        document.getElementById('editor-wrapper').style.filter = 'blur(4px)'; // ç¨å¾®æ¨¡ç³ŠèƒŒæ™¯ä»¥ç¤ºè­¦
                    }
                }
            }

            // è¨ˆç®—æ•´é«”å£“åŠ›
            calculateStress();
        }

        function analyzeFace(detection) {
            const ex = detection.expressions;
            const sorted = Object.entries(ex).sort((a,b) => b[1]-a[1]);
            const top = sorted[0][0];

            let isBadFace = 0;
            const map = {
                'happy': {t:'é–‹å¿ƒ/è‡ªä¿¡', c:'#00ff9d'},
                'neutral': {t:'å¹³éœ/å°ˆæ³¨', c:'#00ccff'},
                'sad': {t:'æŒ«æŠ˜', c:'#ff3333'},
                'angry': {t:'ç”Ÿæ°£/ç„¦æ…®', c:'#ff3333'},
                'fearful': {t:'ç·Šå¼µ', c:'orange'},
                'surprised': {t:'é©šè¨', c:'yellow'},
                'disgusted': {t:'å­æƒ¡', c:'purple'}
            };
            
            const info = map[top] || {t:top, c:'white'};
            const el = document.getElementById('emo-val');
            el.innerText = info.t;
            el.style.color = info.c;

            // å®šç¾©ä»€éº¼æ˜¯ã€Œè² é¢è¡¨æƒ…ã€ (ç”¨æ–¼è¨ˆç®—å£“åŠ›)
            if (['sad', 'angry', 'fearful', 'disgusted'].includes(top)) isBadFace = 1;

            // æ›´æ–°æ­·å²çª—å£
            emoHistory.push(isBadFace);
            if(emoHistory.length > EMO_WINDOW) emoHistory.shift();
        }

        // --- ğŸ“Š å£“åŠ›è¨ˆç®—é‚è¼¯ ---
        function calculateStress() {
            // A. è¡¨æƒ…å£“åŠ›
            let faceStress = 0;
            if(emoHistory.length > 0) {
                const badCount = emoHistory.reduce((a,b)=>a+b, 0);
                faceStress = (badCount / emoHistory.length) * 100;
            }

            // B. æ–‡å­—è² é¢æŒ‡æ•¸ (éš¨æ™‚é–“è‡ªç„¶å†·å»)
            if(textNegativeScore > 0) textNegativeScore -= 0.2; // å†·å»é€Ÿåº¦

            // ç¶œåˆè¨ˆç®— (æ–‡å­—æ¬Šé‡è¼ƒé«˜ï¼Œå› ç‚ºç›´æ¥ç½µäººé€šå¸¸ä»£è¡¨å¾ˆä¸çˆ½)
            // å¦‚æœè‡‰éƒ¨åµæ¸¬ä¸åˆ°(è¶´è‘—)ï¼Œå£“åŠ›ä¸å¢åŠ ï¼Œä½†æœƒè§¸ç™¼å§¿å‹¢è­¦å‘Š(å¦ä¸€æ¢è·¯å¾‘)
            stressScore = (faceStress * 0.4) + Math.min(100, textNegativeScore);

            // UI æ›´æ–°
            const bar = document.getElementById('stress-bar');
            bar.style.width = Math.min(100, stressScore) + "%";
            
            if(stressScore < 40) bar.style.background = "#00ff9d";
            else if(stressScore < 80) bar.style.background = "orange";
            else bar.style.background = "#ff3333";

            // è§¸ç™¼æ²»ç™‚ (é–¾å€¼ 85)
            if(stressScore > 85) {
                triggerTherapy();
            }
        }

        // --- ğŸ“ æ–‡å­—èˆ‡è¡Œç‚ºåˆ†æ ---
        function analyzeTextBehavior(text) {
            let penalty = 0;
            let statusText = "æ­£å¸¸";
            let statusClass = "val";

            // 1. äº‚ç¢¼/é‡è¤‡å­—å…ƒåµæ¸¬ (ä¾‹å¦‚: "aaaaa", "asdfasdf")
            // æ­£å‰‡è§£é‡‹ï¼šåµæ¸¬åŒä¸€å€‹å­—å…ƒé€£çºŒå‡ºç¾ 5 æ¬¡ä»¥ä¸Š
            const repeatedChars = /(.)\1{4,}/; 
            if (repeatedChars.test(text) || text.length > 50 && !text.includes(' ')) {
                penalty += 40; // äº‚æ‰“æ‡²ç½°é‡
                statusText = "äº‚ç¢¼/æ•·è¡";
                statusClass = "val bad";
            }

            // 2. è² é¢é—œéµå­—åµæ¸¬
            const negativeWords = ['é›£', 'ä¸æœƒ', 'ç…©', 'çˆ›', 'è¨å­', 'æ”¾æ£„', 'çœ‹ä¸æ‡‚', 'error', 'å¤±æ•—', 'ç¬¨', 'åƒåœ¾'];
            let hit = false;
            negativeWords.forEach(w => {
                if(text.includes(w)) hit = true;
            });

            if(hit) {
                penalty += 30;
                statusText = "è² é¢è¨€èª";
                statusClass = "val bad";
            }

            // æ›´æ–°åˆ†æ•¸
            textNegativeScore += penalty;
            
            // æ›´æ–° UI
            const el = document.getElementById('text-sentiment-val');
            el.innerText = statusText;
            el.className = statusClass;

            return penalty > 0; // å›å‚³æ˜¯å¦ç‚ºè² é¢è¡Œç‚º
        }

        // --- ğŸ¤– AI èŠå¤©åŠŸèƒ½ ---
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
            addMsg('user', text);
            input.value = "";
            
            // åˆ†æè¡Œç‚º
            const isNegative = analyzeTextBehavior(text);

            // å‘¼å« AI
            addMsg('system', 'AI æ€è€ƒä¸­...');
            
            const codeContext = document.getElementById('code').value;
            let systemPrompt = `
            ä½ æ˜¯ Code Nexus çš„ AI æˆ°è¡“é¡§å•ã€‚
            å­¸ç”Ÿæ­£åœ¨è§£é¡Œï¼š${document.getElementById('m-title').innerText}
            å­¸ç”Ÿç¨‹å¼ç¢¼ï¼š${codeContext}
            å­¸ç”Ÿè¨Šæ¯ï¼š${text}
            
            è«‹éµå®ˆï¼š
            1. å›ç­”è¦ç°¡çŸ­ã€åƒå€‹é§­å®¢é¡§å•ã€‚
            2. ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
            `;

            if (isNegative) {
                systemPrompt += `
                æ³¨æ„ï¼šå­¸ç”Ÿä¼¼ä¹æ­£åœ¨æƒ…ç·’ç™¼æ´©ã€äº‚æ‰“å­—æˆ–èªªè² é¢çš„è©±ã€‚
                è«‹ç”¨å¹½é»˜æˆ–ç¨å¾®åš´è‚…çš„æ–¹å¼æé†’ä»–å°ˆæ³¨ä»»å‹™ï¼Œä¸è¦éš¨ä¹‹èµ·èˆã€‚
                `;
            } else {
                systemPrompt += `å¦‚æœå­¸ç”Ÿåœ¨å•ç¨‹å¼å•é¡Œï¼Œè«‹å¼•å°ä»–è€Œä¸æ˜¯ç›´æ¥çµ¦ç­”æ¡ˆã€‚`;
            }
            
            const reply = await callGemini(systemPrompt);
            document.querySelector('#chat-box .msg.system').remove(); 
            addMsg('ai', marked.parse(reply));
        }

        // --- ä»»å‹™ç”Ÿæˆ ---
        async function generateNewMission() {
            const btn = document.querySelector('.btn-gen');
            btn.innerText = "ç”Ÿæˆä¸­...";
            btn.disabled = true;

            const prompt = `
            è«‹æ‰®æ¼”ä¸€å€‹è³½åšé¾å…‹ (Cyberpunk) é¢¨æ ¼çš„ç¨‹å¼å°å¸«ã€‚
            è«‹ã€Œç”Ÿæˆä¸€å€‹ã€Python åˆå­¸è€…é¡Œç›®ã€‚
            
            è«‹åš´æ ¼éµå®ˆä»¥ä¸‹ JSON æ ¼å¼å›å‚³ï¼Œä¸è¦æœ‰ markdown æ¨™è¨˜ï¼š
            {
                "title": "ä»»å‹™æ¨™é¡Œ",
                "story": "ä¸€æ®µ 30 å­—ä»¥å…§çš„ç§‘å¹»æƒ…å¢ƒæè¿°",
                "task": "å…·é«”çš„ç¨‹å¼ä»»å‹™èªªæ˜",
                "default_code": "# ä½ çš„ç¨‹å¼ç¢¼...",
                "validation_keyword": "åŸ·è¡Œçµæœä¸­å¿…é ˆåŒ…å«çš„é—œéµå­—"
            }
            é¡Œç›®é›£åº¦ï¼šé©åˆ Python åˆå­¸è€…ã€‚ç¹é«”ä¸­æ–‡ã€‚
            `;

            try {
                let jsonStr = await callGemini(prompt);
                jsonStr = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                const data = JSON.parse(jsonStr);
                
                document.getElementById('m-title').innerText = data.title;
                document.getElementById('m-story').innerText = data.story;
                document.getElementById('m-task').innerText = data.task;
                document.getElementById('code').value = data.default_code;
                currentValidation = data.validation_keyword;
                
                addMsg('ai', `æ–°ä»»å‹™å·²ä¸‹é”ï¼š${data.title}ã€‚`);

            } catch(e) {
                console.error(e);
                addMsg('system', 'ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
            }
            
            btn.innerText = "ğŸ”„ ç”Ÿæˆæ–°æŒ‘æˆ°";
            btn.disabled = false;
        }

        // --- æ²»ç™‚æ¨¡å¼ ---
        async function triggerTherapy() {
            if(isTherapy) return;
            isTherapy = true;
            
            document.getElementById('therapy-overlay').style.display = 'flex';
            document.getElementById('editor-wrapper').style.filter = 'blur(10px)';
            document.getElementById('btn-resume').style.opacity = '0';

            const aiText = document.getElementById('ai-therapy-text');
            aiText.innerText = "AI æ­£åœ¨åµæ¸¬ç³»çµ±ç•°å¸¸ä¸¦é‡çµ„ç¥ç¶“ç¶²è·¯...";

            const prompt = `
            å­¸ç”Ÿç¾åœ¨æƒ…ç·’å¤±æ§æˆ–æ•…æ„æ—äº‚ (Stress/Behavior Level > 85%)ã€‚
            è«‹è¬›ä¸€å€‹éå¸¸å†·çš„ã€Œå·¥ç¨‹å¸«ç¬‘è©±ã€ä¾†ç·©å’Œæ°£æ°›ï¼Œæˆ–è€…ç”¨é§­å®¢çš„å£å»å«ä»–å†·éœä¸€é»ã€‚
            ç¹é«”ä¸­æ–‡ã€‚
            `;
            
            const reply = await callGemini(prompt);
            
            let i = 0;
            aiText.innerHTML = "";
            const interval = setInterval(() => {
                aiText.innerHTML += reply.charAt(i);
                i++;
                if(i >= reply.length) {
                    clearInterval(interval);
                    document.getElementById('btn-resume').style.opacity = '1';
                }
            }, 50);
            
            stressScore = 30;
            textNegativeScore = 0;
            emoHistory = [];
        }

        function closeTherapy() {
            document.getElementById('therapy-overlay').style.display = 'none';
            document.getElementById('editor-wrapper').style.filter = 'none';
            isTherapy = false;
        }

        // --- API & Python ---
        async function callGemini(text) {
            if(API_KEY.includes("è«‹åœ¨æ­¤")) {
                alert("è«‹å¡«å…¥ API Keyï¼");
                return "API Key Error";
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text }] }] })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch(e) {
                return "é€£ç·šéŒ¯èª¤ã€‚";
            }
        }

        async function runPythonCode() {
            const code = document.getElementById('code').value;
            const out = document.getElementById('output');
            out.innerText = ">>> åŸ·è¡Œä¸­...\n";

            if(!pyodide) {
                out.innerText += "ç³»çµ±å°šæœªå°±ç·’ã€‚";
                return;
            }

            try {
                pyodide.setStdout({ batched: (msg) => { out.innerText += msg + "\n"; } });
                await pyodide.runPythonAsync(code);

                const result = out.innerText;
                if(currentValidation && result.includes(currentValidation)) {
                    out.innerText += `\n[SYSTEM]: âœ… æˆåŠŸåµæ¸¬é—œéµè¨Šè™Ÿ "${currentValidation}"`;
                    addMsg('ai', 'ä»£ç¢¼åŸ·è¡ŒæˆåŠŸã€‚æ¬Šé™å·²æå‡ã€‚');
                } else if (currentValidation) {
                    out.innerText += `\n[SYSTEM]: âš ï¸ æœªåµæ¸¬åˆ°é æœŸè¼¸å‡º "${currentValidation}"`;
                }

            } catch(err) {
                out.innerText += "\n[Error]: " + err;
            }
        }

        function addMsg(role, html) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = html;
            const box = document.getElementById('chat-box');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

    </script>
</body>
</html>
