<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus: AI æƒ…å¢ƒå¼å­¸ç¿’ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #101010;
            --accent: #00ff9d;
            --accent-dim: #005533;
            --danger: #ff3333;
            --warning: #ffcc00;
            --next-btn: #0088ff;
            --border: #333;
            --text: #e0e0e0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text);
            font-family: 'Segoe UI', 'Microsoft JhengHei', monospace;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .panel-left {
            width: 320px; background: var(--panel-bg); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 15px; z-index: 10;
        }

        .cam-box {
            height: 200px; background: #000; border: 2px solid var(--accent);
            border-radius: 6px; position: relative; margin-bottom: 10px; overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .status-box {
            background: #1a1a1a; padding: 12px; border-radius: 6px;
            margin-bottom: 10px; border: 1px solid #222;
        }
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; }
        .val { font-weight: bold; color: var(--accent); }
        .val.bad { color: var(--danger); }
        .val.warn { color: var(--warning); }

        .stress-bar-bg {
            height: 8px; background: #333; border-radius: 4px; margin-top: 5px; overflow: hidden;
        }
        .stress-bar {
            height: 100%; width: 0%; background: var(--accent); transition: width 0.5s ease-out, background 0.5s;
        }

        #chat-box {
            flex-grow: 1; background: #080808; border: 1px solid var(--border);
            border-radius: 6px; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px;
        }
        .msg { padding: 10px; border-radius: 8px; font-size: 0.9em; line-height: 1.5; max-width: 90%; word-wrap: break-word; }
        .msg.ai { background: #1a2a1a; border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.user { background: #004455; align-self: flex-end; }
        .msg.system { background: transparent; color: #666; font-size: 0.8em; text-align: center; align-self: center; border: none; padding: 0;}

        #chat-input {
            background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px; margin-top: 10px; border-radius: 4px; width: 100%; box-sizing: border-box;
        }

        .panel-right {
            flex-grow: 1; padding: 20px; display: flex; flex-direction: column; position: relative;
        }

        .mission-card {
            background: #151515; border-left: 5px solid var(--accent);
            padding: 20px; border-radius: 0 8px 8px 0; margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .mission-title { font-size: 1.5em; margin: 0; color: white; }
        .mission-task { background: #222; padding: 10px; margin-top: 10px; border-radius: 4px; color: var(--accent); font-family: monospace; }
        
        #editor-wrapper {
            flex-grow: 1; display: flex; flex-direction: column; border: 1px solid var(--border);
            border-radius: 8px; overflow: hidden; transition: filter 0.5s;
        }
        textarea {
            flex-grow: 1; background: #0c0c0c; color: #dcdcdc; border: none; padding: 20px;
            font-family: 'Consolas', 'Courier New', monospace; font-size: 16px; resize: none; outline: none;
        }
        
        .editor-footer {
            background: #1a1a1a; padding: 10px; display: flex; justify-content: flex-end; align-items: center; border-top: 1px solid #333; gap: 15px;
        }
        .btn-run {
            background: var(--accent-dim); color: #fff; border: 1px solid var(--accent);
            padding: 8px 25px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1em;
        }
        .btn-run:hover { background: var(--accent); color: #000; }

        .btn-next {
            background: var(--next-btn); color: white; border: 1px solid #0055aa;
            padding: 8px 25px; border-radius: 4px; cursor: pointer; font-weight: bold;
            font-size: 1em; display: none; animation: popIn 0.5s;
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        #output {
            height: 120px; background: #000; color: #aaa; padding: 15px; font-family: monospace; border-top: 1px solid #333; overflow-y: auto; white-space: pre-wrap;
        }

        #posture-overlay {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 204, 0, 0.9); color: #000; padding: 15px 30px;
            border-radius: 30px; font-weight: bold; z-index: 500; display: none;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% {opacity:0.8;} 50% {transform: translateX(-50%) scale(1.05);} 100% {opacity:0.8;} }

        #therapy-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.95); z-index: 999; display: none;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .therapy-box {
            width: 500px; padding: 40px; border: 2px solid var(--danger);
            border-radius: 12px; background: #111;
        }
        .btn-resume {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            padding: 10px 30px; margin-top: 20px; cursor: pointer; opacity: 0; transition: 1s;
        }
    </style>
</head>
<body>

    <div id="posture-overlay">âš ï¸ åµæ¸¬ä¸åˆ°ä½¿ç”¨è€…ï¼Œè«‹åæ­£æˆ–å›åˆ°åº§ä½</div>

    <div class="panel-left">
        <h3 style="color:var(--accent); text-align:center; margin-top:0;">NEXUS v5.4</h3>
        <div class="cam-box"><video id="video" autoplay muted playsinline></video></div>

        <div class="status-box">
            <div class="metric-row"><span>æƒ…ç·’ç‹€æ…‹:</span><span id="emo-val" class="val">åˆå§‹åŒ–...</span></div>
            <div class="metric-row"><span>è¡Œç‚ºåµæ¸¬:</span><span id="behavior-val" class="val" style="color:gray;">æ­£å¸¸</span></div>
            <div style="margin-top:10px; font-size:0.8em; color:gray;">ç²¾ç¥è² è¼‰ (Stress Level)</div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-bar"></div></div>
        </div>

        <div id="chat-box">
            <div class="msg ai">é§­å®¢ä½ å¥½ã€‚æˆ‘æ˜¯ä½ çš„æˆ°è¡“é¡§å•ã€‚è«‹å®Œæˆåˆå§‹åŒ–ä»»å‹™ã€‚</div>
        </div>
        <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') sendChat()" autocomplete="off">
    </div>

    <div class="panel-right">
        <div id="therapy-overlay">
            <div class="therapy-box">
                <h2 style="color: var(--danger); margin:0;">âš ï¸ ç³»çµ±å¼·åˆ¶ä»‹å…¥</h2>
                <p style="color:#888;">åµæ¸¬åˆ°æƒ…ç·’å¤±æ§æˆ–ç„¡æ„ç¾©è¡Œç‚ºã€‚</p>
                <hr style="border-color:#333; margin:20px 0;">
                <div id="ai-therapy-text" style="font-size:1.2em; color:#eee;">AI è¨ºæ–·ä¸­...</div>
                <button id="btn-resume" class="btn-resume" onclick="closeTherapy()">æ¢å¾©é€£ç·š â–¶</button>
            </div>
        </div>

        <div class="mission-card" id="mission-card">
            <div class="mission-header">
                <h2 class="mission-title" id="m-title">Level 0: ç³»çµ±æ ¡æº–</h2>
            </div>
            <p id="m-story" style="color:#bbb; font-style:italic;">ç¢ºèªè¼¸å…¥è£ç½®æ­£å¸¸ã€‚</p>
            <div class="mission-task" id="m-task">ä»»å‹™ï¼šè«‹å°å‡º print("System Ready")</div>
        </div>

        <div id="editor-wrapper">
            <textarea id="code" spellcheck="false" placeholder="# åœ¨æ­¤è¼¸å…¥ Python ä»£ç¢¼..."></textarea>
            <div class="editor-footer">
                <button class="btn-run" onclick="runPythonCode()">â–¶ åŸ·è¡Œä»£ç¢¼ (RUN)</button>
                <button id="btn-next" class="btn-next" onclick="generateNewMission()">é€²å…¥ä¸‹ä¸€é—œ â­ï¸</button>
            </div>
            <div id="output">ç­‰å¾…æŒ‡ä»¤...</div>
        </div>
    </div>

    <script>
        // ==========================================
        const API_KEY = "AIzaSyA2k88qSlo4mcuWkjoLBf9Yeb-v4BXgaco"; 
        const MODEL_NAME = "gemini-2.5-flash"; 
        // ==========================================

        // --- ğŸ›¡ï¸ å‚™ç”¨é¡Œåº« (ç•¶ AI æ›æ‰æ™‚ä½¿ç”¨) ---
        const BACKUP_MISSIONS = [
            {
                "title": "Level X: è®Šæ•¸å„²å­˜",
                "story": "æˆ‘å€‘éœ€è¦ä¿å­˜åŠ å¯†é‡‘é‘°ã€‚è«‹å‰µå»ºä¸€å€‹è®Šæ•¸ã€‚",
                "task": "è«‹å®£å‘Šè®Šæ•¸ key = 12345 ä¸¦æŠŠå®ƒ print å‡ºä¾†ã€‚",
                "default_code": "# å®£å‘Šè®Šæ•¸\nkey = \nprint(key)",
                "validation_keyword": "12345"
            },
            {
                "title": "Level Y: é‹ç®—æ ¸å¿ƒ",
                "story": "è¨ˆç®—å¼•æ“å†·å»ä¸­ï¼Œéœ€è¦æ‰‹å‹•è¨ˆç®—è»Œé“ã€‚",
                "task": "è«‹è¨ˆç®— 100 åŠ  200 çš„çµæœä¸¦ print å‡ºä¾†ã€‚",
                "default_code": "a = 100\nb = 200\n# è«‹è¨ˆç®— a + b\n",
                "validation_keyword": "300"
            },
            {
                "title": "Level Z: è¿´åœˆæ”»æ“Š",
                "story": "é˜²ç«ç‰†å¤ªåšï¼Œæˆ‘å€‘éœ€è¦é€£çºŒæ”»æ“Š 3 æ¬¡ã€‚",
                "task": "è«‹ä½¿ç”¨ for è¿´åœˆå°å‡º 3 æ¬¡ 'Attack'ã€‚",
                "default_code": "for i in range(3):\n    # ä½ çš„ä»£ç¢¼",
                "validation_keyword": "Attack"
            }
        ];

        let pyodide = null;
        let isModelLoaded = false;
        let isTherapy = false;
        let stressScore = 0;
        let currentValidation = "System Ready"; 
        let isLevelCleared = false;
        
        // è¼¸å…¥èˆ‡è‡‰éƒ¨è®Šæ•¸
        let mouseDist = 0; let lastMouseX = 0, lastMouseY = 0;
        let backspaceCount = 0; let behaviorPenalty = 0; 
        let hasFace = false; let faceMissingCount = 0;

        async function initSystem() {
            const out = document.getElementById('output');
            setupInputMonitoring();

            try {
                out.innerText = ">>> è¼‰å…¥ Python...";
                pyodide = await loadPyodide();
                out.innerText = ">>> Python Ready.\n>>> å•Ÿå‹•è¦–è¦ºæ¨¡çµ„...";
            } catch(e) { out.innerText = "Python Error: " + e; }

            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
            ]);
            isModelLoaded = true;

            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                video.addEventListener('play', () => {
                    // ğŸš€ å„ªåŒ–ï¼šäººè‡‰åµæ¸¬æ”¹ç‚º 1000ms (1ç§’) ä¸€æ¬¡ï¼Œæ¸›å°‘ CPU è² è¼‰
                    setInterval(monitorLoop, 1000); 
                });
                out.innerText = ">>> ç³»çµ±å…¨æ•¸é‹ä½œæ­£å¸¸ã€‚";
            } catch(e) { out.innerText += "\n[è­¦å‘Š] ç„¡æ³•å­˜å–æ”å½±æ©Ÿã€‚"; }
        }
        initSystem(); 

        function setupInputMonitoring() {
            document.addEventListener('mousemove', (e) => {
                if(lastMouseX === 0) { lastMouseX = e.clientX; lastMouseY = e.clientY; return; }
                const dist = Math.sqrt(Math.pow(e.clientX - lastMouseX, 2) + Math.pow(e.clientY - lastMouseY, 2));
                mouseDist += dist; lastMouseX = e.clientX; lastMouseY = e.clientY;
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' || e.key === 'Delete') backspaceCount++;
            });
        }

        // --- æ•´åˆå¾Œçš„ç›£æ§å¾ªç’° (æ¸›å°‘ Timer æ•¸é‡) ---
        async function monitorLoop() {
            if (isTherapy || !isModelLoaded) return;
            const video = document.getElementById('video');

            // 1. åŸ·è¡Œäººè‡‰åµæ¸¬
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            const postureOverlay = document.getElementById('posture-overlay');
            const emoEl = document.getElementById('emo-val');
            let behaviorText = "æ­£å¸¸"; let behaviorClass = "val"; let newPenalty = 0;

            if (detections.length > 0) {
                hasFace = true; faceMissingCount = 0;
                postureOverlay.style.display = 'none';
                document.getElementById('editor-wrapper').style.filter = 'none';

                const ex = detections[0].expressions;
                const top = Object.entries(ex).sort((a,b) => b[1]-a[1])[0][0];
                const map = { 'happy':'é–‹å¿ƒ', 'neutral':'å¹³éœ', 'sad':'æŒ«æŠ˜', 'angry':'ç”Ÿæ°£', 'fearful':'ç·Šå¼µ', 'surprised':'é©šè¨', 'disgusted':'å­æƒ¡' };
                emoEl.innerText = map[top] || top;
                if(['sad', 'angry'].includes(top)) behaviorPenalty += 2; // è¡¨æƒ…ä¸å¥½åŠ å£“åŠ›
            } else {
                if (hasFace) {
                    faceMissingCount++;
                    emoEl.innerText = "éºå¤±è¨Šè™Ÿ...";
                    // 1ç§’ä¸€æ¬¡ï¼Œç´¯ç© 5 æ¬¡å°±æ˜¯ 5 ç§’
                    if (faceMissingCount > 5) {
                        postureOverlay.style.display = 'block';
                        document.getElementById('editor-wrapper').style.filter = 'blur(5px)';
                    }
                }
            }

            // 2. åŸ·è¡Œè¡Œç‚ºåµæ¸¬
            if (mouseDist > 3000) { behaviorText = "æ»‘é¼ éå‹•"; behaviorClass = "val warn"; newPenalty += 10; }
            if (backspaceCount > 8) { behaviorText = "é »ç¹åˆªé™¤"; behaviorClass = "val warn"; newPenalty += 10; }

            mouseDist = 0; backspaceCount = 0;
            const bEl = document.getElementById('behavior-val');
            bEl.innerText = behaviorText; bEl.className = behaviorClass;

            // 3. è¨ˆç®—ç¸½å£“åŠ›
            if (newPenalty > 0) behaviorPenalty += newPenalty;
            else behaviorPenalty = Math.max(0, behaviorPenalty - 3); // æ¢å¾©é€Ÿåº¦

            stressScore = Math.min(100, behaviorPenalty);
            const bar = document.getElementById('stress-bar');
            bar.style.width = stressScore + "%";
            
            if(stressScore < 40) bar.style.background = "#00ff9d";
            else if(stressScore < 85) bar.style.background = "orange";
            else bar.style.background = "#ff3333";

            if(stressScore > 90) triggerTherapy();
        }

        // --- ç”Ÿæˆæ–°é¡Œç›® (å«å‚™ç”¨æ©Ÿåˆ¶) ---
        async function generateNewMission() {
            const btn = document.getElementById('btn-next');
            btn.innerText = "ç”Ÿæˆä¸­ (AI)...";
            btn.disabled = true;

            const prompt = `ç”Ÿæˆä¸€å€‹ Python åˆå­¸è€…é¡Œç›®ã€‚
            å›å‚³ç´” JSONï¼Œä¸è¦ç”¨ markdownï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ã€‚
            æ ¼å¼: { "title": "..", "story": "..", "task": "..", "default_code": "..", "validation_keyword": ".." }`;

            try {
                let jsonStr = await callGemini(prompt);
                // ğŸ§¹ å¼·åŒ–æ¸…ç†ï¼šåªå–ç¬¬ä¸€å€‹ { åˆ°æœ€å¾Œä¸€å€‹ }
                const firstBrace = jsonStr.indexOf('{');
                const lastBrace = jsonStr.lastIndexOf('}');
                
                let data;
                if (firstBrace !== -1 && lastBrace !== -1) {
                    const cleanJson = jsonStr.substring(firstBrace, lastBrace + 1);
                    data = JSON.parse(cleanJson);
                } else {
                    throw new Error("JSON æ ¼å¼éŒ¯èª¤");
                }
                
                applyMission(data);

            } catch(e) {
                console.warn("AI ç”Ÿæˆå¤±æ•—ï¼Œå•Ÿç”¨å‚™ç”¨æ–¹æ¡ˆ...", e);
                // ğŸ›¡ï¸ å•Ÿç”¨å‚™ç”¨é¡Œç›® (éš¨æ©Ÿé¸ä¸€é¡Œ)
                const backup = BACKUP_MISSIONS[Math.floor(Math.random() * BACKUP_MISSIONS.length)];
                applyMission(backup);
                addMsg('system', 'é€£ç·šä¸ç©©ï¼Œå·²è¼‰å…¥å‚™ç”¨è¨“ç·´æ¨¡çµ„ã€‚');
            }
            
            // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            btn.innerText = "é€²å…¥ä¸‹ä¸€é—œ â­ï¸";
            btn.style.display = 'none';
            btn.disabled = false;
        }

        function applyMission(data) {
            document.getElementById('m-title').innerText = data.title;
            document.getElementById('m-story').innerText = data.story;
            document.getElementById('m-task').innerText = data.task;
            document.getElementById('code').value = data.default_code;
            currentValidation = data.validation_keyword;
            isLevelCleared = false;
            addMsg('ai', `ä»»å‹™æ›´æ–°ï¼š${data.title}`);
        }

        // --- AI å°è©± ---
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            addMsg('user', text);
            input.value = "";
            addMsg('system', 'AI åˆ†æä¸­...');

            const prompt = `
            ä½ æ˜¯é§­å®¢å°å¸«ã€‚å­¸ç”Ÿèªªï¼š${text}
            å›å‚³ JSON: { "reply": "ä½ çš„å›è¦†(ç¹é«”ä¸­æ–‡)", "sentiment": "negative/neutral/positive" }
            ä¸€å®šè¦ JSON æ ¼å¼ã€‚`;
            
            try {
                const res = await callGemini(prompt);
                const first = res.indexOf('{'); const last = res.lastIndexOf('}');
                const data = JSON.parse(res.substring(first, last+1));
                
                document.querySelector('#chat-box .msg.system').remove();

                if (data.sentiment === "negative") {
                    behaviorPenalty += 30;
                    addMsg('system', `âš ï¸ åµæ¸¬åˆ°è² é¢æƒ…ç·’`);
                }
                addMsg('ai', marked.parse(data.reply));
            } catch(e) {
                document.querySelector('#chat-box .msg.system').remove();
                addMsg('ai', 'æ”¶åˆ°ã€‚ä¿æŒå°ˆæ³¨ã€‚(é€šè¨Šå¹²æ“¾)');
            }
        }

        // --- æ²»ç™‚æ¨¡å¼ ---
        async function triggerTherapy() {
            if(isTherapy) return;
            isTherapy = true;
            document.getElementById('therapy-overlay').style.display = 'flex';
            document.getElementById('editor-wrapper').style.filter = 'blur(10px)';
            document.getElementById('btn-resume').style.opacity = '0';
            
            const aiText = document.getElementById('ai-therapy-text');
            aiText.innerText = "ç³»çµ±å†·å»ä¸­...";
            
            // ç°¡å–®çš„å…§å»ºç¬‘è©±ï¼Œé¿å… AI åœ¨é€™æ™‚å€™åˆå¡ä½
            const jokes = [
                "ç‚ºä»€éº¼å·¥ç¨‹å¸«åˆ†ä¸æ¸…è¬è–ç¯€å’Œè–èª•ç¯€ï¼Ÿå› ç‚º Oct 31 == Dec 25ã€‚",
                "ä¸€å€‹ 0 å° 8 èªªï¼šä½ æ€éº¼ç¹«äº†çš®å¸¶ï¼Ÿ",
                "ç¨‹å¼è¨­è¨ˆå¸«æœ€è¨å­åº·ç†™çš„å“ªå€‹å…’å­ï¼Ÿèƒ¤ç¦© (å› ç‚º in 8)ã€‚",
                "å†·éœï¼Œæ·±å‘¼å¸ã€‚ä½ çš„è…¦è¢‹éœ€è¦é‡çµ„ã€‚"
            ];
            const reply = jokes[Math.floor(Math.random() * jokes.length)];

            let i = 0; aiText.innerHTML = "";
            const interval = setInterval(() => {
                aiText.innerHTML += reply.charAt(i); i++;
                if(i >= reply.length) { clearInterval(interval); document.getElementById('btn-resume').style.opacity = '1'; }
            }, 50);
            behaviorPenalty = 40;
        }

        function closeTherapy() {
            document.getElementById('therapy-overlay').style.display = 'none';
            document.getElementById('editor-wrapper').style.filter = 'none';
            isTherapy = false;
        }

        async function runPythonCode() {
            const code = document.getElementById('code').value;
            const out = document.getElementById('output');
            out.innerText = ">>> åŸ·è¡Œä¸­...\n";

            try {
                if(!pyodide) { out.innerText += "Python æ ¸å¿ƒå°šæœªè¼‰å…¥..."; return; }
                pyodide.setStdout({ batched: (m) => out.innerText += m + "\n" });
                await pyodide.runPythonAsync(code);

                if(out.innerText.includes(currentValidation)) {
                    out.innerText += `\n[SYSTEM]: âœ… ä»»å‹™é”æˆï¼`;
                    if (!isLevelCleared) {
                        isLevelCleared = true;
                        addMsg('ai', 'ä»£ç¢¼é©—è­‰é€šéã€‚ä¸‹ä¸€é—œæ¬Šé™å·²è§£é–ã€‚');
                        document.getElementById('btn-next').style.display = 'inline-block';
                    }
                }
            } catch(e) { out.innerText += "\nError: " + e; }
        }

        async function callGemini(text) {
            if(API_KEY.includes("è«‹åœ¨æ­¤")) { alert("API KEY ç¼ºå¤±"); throw new Error("No Key"); }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            const res = await fetch(url, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text }] }] })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

        function addMsg(role, html) {
            const div = document.createElement('div'); div.className = `msg ${role}`; div.innerHTML = html;
            const box = document.getElementById('chat-box'); box.appendChild(div); box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
