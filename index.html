<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus: AI æƒ…å¢ƒå¼å­¸ç¿’ç³»çµ± (v5.3 - é—–é—œç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #101010;
            --accent: #00ff9d;
            --accent-dim: #005533;
            --danger: #ff3333;
            --warning: #ffcc00;
            --next-btn: #0088ff; /* ä¸‹ä¸€é—œæŒ‰éˆ•é¡è‰² */
            --border: #333;
            --text: #e0e0e0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text);
            font-family: 'Segoe UI', 'Microsoft JhengHei', monospace;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- å·¦å´ --- */
        .panel-left {
            width: 320px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
            z-index: 10;
        }

        .cam-box {
            height: 200px;
            background: #000;
            border: 2px solid var(--accent);
            border-radius: 6px;
            position: relative;
            margin-bottom: 10px;
            overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .status-box {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #222;
        }

        .metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; }
        .val { font-weight: bold; color: var(--accent); }
        .val.bad { color: var(--danger); }
        .val.warn { color: var(--warning); }

        .stress-bar-bg {
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        .stress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent);
            transition: width 0.5s ease-out, background 0.5s;
        }

        #chat-box {
            flex-grow: 1;
            background: #080808;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .msg { padding: 10px; border-radius: 8px; font-size: 0.9em; line-height: 1.5; max-width: 90%; word-wrap: break-word; }
        .msg.ai { background: #1a2a1a; border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.user { background: #004455; align-self: flex-end; }
        .msg.system { background: transparent; color: #666; font-size: 0.8em; text-align: center; align-self: center; border: none; padding: 0;}

        #chat-input {
            background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px; margin-top: 10px; border-radius: 4px; width: 100%; box-sizing: border-box;
        }

        /* --- å³å´ --- */
        .panel-right {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .mission-card {
            background: #151515;
            border-left: 5px solid var(--accent);
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .mission-title { font-size: 1.5em; margin: 0; color: white; }
        .mission-task { background: #222; padding: 10px; margin-top: 10px; border-radius: 4px; color: var(--accent); font-family: monospace; }
        
        /* ç·¨è¼¯å™¨èˆ‡æŒ‰éˆ•å€åŸŸ */
        #editor-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: filter 0.5s;
        }
        textarea {
            flex-grow: 1;
            background: #0c0c0c;
            color: #dcdcdc;
            border: none;
            padding: 20px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 16px;
            resize: none;
            outline: none;
        }
        
        .editor-footer {
            background: #1a1a1a;
            padding: 10px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            border-top: 1px solid #333;
            gap: 15px; /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
        }

        .btn-run {
            background: var(--accent-dim); color: #fff; border: 1px solid var(--accent);
            padding: 8px 25px; border-radius: 4px; cursor: pointer; font-weight: bold;
            font-size: 1em; transition: 0.2s;
        }
        .btn-run:hover { background: var(--accent); color: #000; }

        /* æ–°å¢ï¼šä¸‹ä¸€é—œæŒ‰éˆ• (é è¨­éš±è—) */
        .btn-next {
            background: var(--next-btn); color: white; border: 1px solid #0055aa;
            padding: 8px 25px; border-radius: 4px; cursor: pointer; font-weight: bold;
            font-size: 1em; display: none; /* é—œéµï¼šé è¨­ä¸é¡¯ç¤º */
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-next:hover { background: #3399ff; box-shadow: 0 0 10px #0088ff; }

        @keyframes popIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        #output {
            height: 120px; background: #000; color: #aaa; padding: 15px; font-family: monospace; border-top: 1px solid #333; overflow-y: auto; white-space: pre-wrap;
        }

        /* --- è¦†è“‹å±¤ --- */
        #posture-overlay {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 204, 0, 0.9); color: #000; padding: 15px 30px;
            border-radius: 30px; font-weight: bold; z-index: 500; display: none;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% {opacity:0.8;} 50% {transform: translateX(-50%) scale(1.05);} 100% {opacity:0.8;} }

        #therapy-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.95); z-index: 999; display: none;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .therapy-box {
            width: 500px; padding: 40px; border: 2px solid var(--danger);
            border-radius: 12px; background: #111;
        }
        .btn-resume {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            padding: 10px 30px; margin-top: 20px; cursor: pointer; opacity: 0; transition: 1s;
        }

    </style>
</head>
<body>

    <div id="posture-overlay">âš ï¸ åµæ¸¬ä¸åˆ°ä½¿ç”¨è€…ï¼Œè«‹åæ­£æˆ–å›åˆ°åº§ä½</div>

    <div class="panel-left">
        <h3 style="color:var(--accent); text-align:center; margin-top:0;">NEXUS v5.3</h3>
        
        <div class="cam-box">
            <video id="video" autoplay muted playsinline></video>
        </div>

        <div class="status-box">
            <div class="metric-row">
                <span>æƒ…ç·’ç‹€æ…‹ (Face):</span>
                <span id="emo-val" class="val">åˆå§‹åŒ–...</span>
            </div>
            <div class="metric-row">
                <span>è¡Œç‚ºåµæ¸¬ (Action):</span>
                <span id="behavior-val" class="val" style="color:gray;">æ­£å¸¸</span>
            </div>
            
            <div style="margin-top:10px; font-size:0.8em; color:gray;">ç²¾ç¥è² è¼‰ (Stress Level)</div>
            <div class="stress-bar-bg">
                <div id="stress-bar" class="stress-bar"></div>
            </div>
        </div>

        <div id="chat-box">
            <div class="msg ai">é§­å®¢ä½ å¥½ã€‚æˆ‘æ˜¯ä½ çš„æˆ°è¡“é¡§å•ã€‚è«‹å®Œæˆåˆå§‹åŒ–ä»»å‹™ä»¥è§£é–ä¸‹ä¸€é—œã€‚</div>
        </div>
        <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') sendChat()" autocomplete="off">
    </div>

    <div class="panel-right">
        
        <div id="therapy-overlay">
            <div class="therapy-box">
                <h2 style="color: var(--danger); margin:0;">âš ï¸ ç³»çµ±å¼·åˆ¶ä»‹å…¥</h2>
                <p style="color:#888;">åµæ¸¬åˆ°æƒ…ç·’å¤±æ§æˆ–ç„¡æ„ç¾©è¡Œç‚ºã€‚</p>
                <hr style="border-color:#333; margin:20px 0;">
                <div id="ai-therapy-text" style="font-size:1.2em; color:#eee;">AI è¨ºæ–·ä¸­...</div>
                <button id="btn-resume" class="btn-resume" onclick="closeTherapy()">æ¢å¾©é€£ç·š â–¶</button>
            </div>
        </div>

        <div class="mission-card" id="mission-card">
            <div class="mission-header">
                <h2 class="mission-title" id="m-title">Level 0: ç³»çµ±æ ¡æº–</h2>
                <!-- èˆŠçš„ç”ŸæˆæŒ‰éˆ•å·²ç§»é™¤ -->
            </div>
            <p id="m-story" style="color:#bbb; font-style:italic;">ç¢ºèªè¼¸å…¥è£ç½®æ­£å¸¸ã€‚</p>
            <div class="mission-task" id="m-task">ä»»å‹™ï¼šè«‹å°å‡º print("System Ready")</div>
        </div>

        <div id="editor-wrapper">
            <textarea id="code" spellcheck="false" placeholder="# åœ¨æ­¤è¼¸å…¥ Python ä»£ç¢¼..."></textarea>
            
            <!-- åº•éƒ¨æŒ‰éˆ•å€ -->
            <div class="editor-footer">
                <button class="btn-run" onclick="runPythonCode()">â–¶ åŸ·è¡Œä»£ç¢¼ (RUN)</button>
                <!-- æ–°å¢ï¼šéé—œå¾Œæ‰å‡ºç¾çš„æŒ‰éˆ• -->
                <button id="btn-next" class="btn-next" onclick="generateNewMission()">é€²å…¥ä¸‹ä¸€é—œ â­ï¸</button>
            </div>

            <div id="output">ç­‰å¾…æŒ‡ä»¤...</div>
        </div>
    </div>

    <script>
        // ==========================================
        const API_KEY = "AIzaSyA2k88qSlo4mcuWkjoLBf9Yeb-v4BXgaco"; 
        const MODEL_NAME = "gemini-2.5-flash"; 
        // ==========================================

        let pyodide = null;
        let isModelLoaded = false;
        let isTherapy = false;
        let stressScore = 0;
        let currentValidation = "System Ready"; 
        let isLevelCleared = false; // ç´€éŒ„ç•¶å‰é—œå¡æ˜¯å¦å·²è§£æ±º
        
        let mouseDist = 0;      
        let lastMouseX = 0, lastMouseY = 0;
        let backspaceCount = 0; 
        let behaviorPenalty = 0; 
        let hasFace = false;
        let faceMissingCount = 0;

        async function initSystem() {
            const out = document.getElementById('output');
            setupInputMonitoring();

            try {
                out.innerText = ">>> è¼‰å…¥ Python...";
                pyodide = await loadPyodide();
                out.innerText = ">>> Python Ready.\n>>> å•Ÿå‹•è¦–è¦ºæ¨¡çµ„...";
            } catch(e) { out.innerText = "Python Error: " + e; }

            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
            ]);
            isModelLoaded = true;

            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                video.addEventListener('play', () => {
                    setInterval(monitorLoop, 1000); 
                    setInterval(detectFaceLoop, 200); 
                });
                out.innerText = ">>> ç³»çµ±å…¨æ•¸é‹ä½œæ­£å¸¸ã€‚";
            } catch(e) { out.innerText += "\n[è­¦å‘Š] ç„¡æ³•å­˜å–æ”å½±æ©Ÿã€‚"; }
        }
        initSystem(); 

        // è¼¸å…¥ç›£æ§
        function setupInputMonitoring() {
            document.addEventListener('mousemove', (e) => {
                if(lastMouseX === 0) { lastMouseX = e.clientX; lastMouseY = e.clientY; return; }
                const dist = Math.sqrt(Math.pow(e.clientX - lastMouseX, 2) + Math.pow(e.clientY - lastMouseY, 2));
                mouseDist += dist;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' || e.key === 'Delete') backspaceCount++;
            });
        }

        // ç›£æ§å¾ªç’°
        function monitorLoop() {
            if (isTherapy) return;
            let behaviorText = "æ­£å¸¸";
            let behaviorClass = "val";
            let newPenalty = 0;

            if (mouseDist > 3000) {
                behaviorText = "æ»‘é¼ éå‹•"; behaviorClass = "val warn"; newPenalty += 10;
            }
            if (backspaceCount > 8) { // æ”¾å¯¬ä¸€é»
                behaviorText = "é »ç¹åˆªé™¤"; behaviorClass = "val warn"; newPenalty += 15;
            }

            mouseDist = 0; backspaceCount = 0;
            const bEl = document.getElementById('behavior-val');
            bEl.innerText = behaviorText; bEl.className = behaviorClass;

            if (newPenalty > 0) behaviorPenalty += newPenalty;
            else behaviorPenalty = Math.max(0, behaviorPenalty - 2); 

            calculateStress();
        }

        // è‡‰éƒ¨åµæ¸¬
        async function detectFaceLoop() {
            if (!isModelLoaded || isTherapy) return;
            const video = document.getElementById('video');
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            const postureOverlay = document.getElementById('posture-overlay');
            const emoEl = document.getElementById('emo-val');

            if (detections.length > 0) {
                hasFace = true; faceMissingCount = 0;
                postureOverlay.style.display = 'none';
                document.getElementById('editor-wrapper').style.filter = 'none';

                const ex = detections[0].expressions;
                const sorted = Object.entries(ex).sort((a,b) => b[1]-a[1]);
                const top = sorted[0][0];
                const map = { 'happy':'é–‹å¿ƒ', 'neutral':'å¹³éœ', 'sad':'æŒ«æŠ˜', 'angry':'ç”Ÿæ°£', 'fearful':'ç·Šå¼µ', 'surprised':'é©šè¨', 'disgusted':'å­æƒ¡' };
                emoEl.innerText = map[top] || top;
                
                if(['sad', 'angry'].includes(top)) behaviorPenalty += 1; 
            } else {
                if (hasFace) {
                    faceMissingCount++;
                    emoEl.innerText = "éºå¤±è¨Šè™Ÿ...";
                    if (faceMissingCount > 25) {
                        postureOverlay.style.display = 'block';
                        document.getElementById('editor-wrapper').style.filter = 'blur(5px)';
                    }
                }
            }
        }

        function calculateStress() {
            stressScore = Math.min(100, behaviorPenalty);
            const bar = document.getElementById('stress-bar');
            bar.style.width = stressScore + "%";
            
            if(stressScore < 40) bar.style.background = "#00ff9d";
            else if(stressScore < 85) bar.style.background = "orange";
            else bar.style.background = "#ff3333";

            if(stressScore > 90) triggerTherapy();
        }

        // AI å°è©±
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            addMsg('user', text);
            input.value = "";
            addMsg('system', 'AI åˆ†æä¸­...');

            const codeContext = document.getElementById('code').value;
            const prompt = `
            ä½ æ˜¯é§­å®¢å°å¸«ã€‚å­¸ç”Ÿæ­£åœ¨è§£é¡Œï¼š${document.getElementById('m-title').innerText}
            ä»£ç¢¼ï¼š${codeContext}
            å­¸ç”Ÿèªªï¼š${text}
            åªå›å‚³ JSONï¼š{ "reply": "...", "sentiment": "negative/neutral/positive" }
            `;
            
            try {
                let raw = await callGemini(prompt);
                raw = raw.replace(/```json/g, '').replace(/```/g, '').trim();
                const data = JSON.parse(raw);
                document.querySelector('#chat-box .msg.system').remove();

                if (data.sentiment === "negative") {
                    behaviorPenalty += 30;
                    addMsg('system', `âš ï¸ åµæ¸¬åˆ°è² é¢æƒ…ç·’`);
                }
                addMsg('ai', marked.parse(data.reply));
            } catch(e) {
                document.querySelector('#chat-box .msg.system').remove();
            }
        }

        // æ²»ç™‚æ¨¡å¼
        async function triggerTherapy() {
            if(isTherapy) return;
            isTherapy = true;
            document.getElementById('therapy-overlay').style.display = 'flex';
            document.getElementById('editor-wrapper').style.filter = 'blur(10px)';
            document.getElementById('btn-resume').style.opacity = '0';
            const aiText = document.getElementById('ai-therapy-text');
            
            const prompt = `ç³»çµ±æš«åœã€‚è«‹è¬›å€‹è¶…å†·ç¬‘è©±ä¾†å®‰æ’«å­¸ç”Ÿã€‚ç¹é«”ä¸­æ–‡ã€‚`;
            const reply = await callGemini(prompt);
            
            let i = 0; aiText.innerHTML = "";
            const interval = setInterval(() => {
                aiText.innerHTML += reply.charAt(i); i++;
                if(i >= reply.length) { clearInterval(interval); document.getElementById('btn-resume').style.opacity = '1'; }
            }, 50);
            behaviorPenalty = 40;
        }

        function closeTherapy() {
            document.getElementById('therapy-overlay').style.display = 'none';
            document.getElementById('editor-wrapper').style.filter = 'none';
            isTherapy = false;
        }

        // ============================================
        // ğŸš€ åŸ·è¡Œä»£ç¢¼èˆ‡é€šé—œé‚è¼¯ (ä¿®æ”¹é‡é»)
        // ============================================
        async function runPythonCode() {
            const code = document.getElementById('code').value;
            const out = document.getElementById('output');
            out.innerText = ">>> åŸ·è¡Œä¸­...\n";

            try {
                pyodide.setStdout({ batched: (m) => out.innerText += m + "\n" });
                await pyodide.runPythonAsync(code);

                // é©—è­‰æ˜¯å¦éé—œ
                if(out.innerText.includes(currentValidation)) {
                    out.innerText += `\n[SYSTEM]: âœ… ä»»å‹™é”æˆï¼æ¬Šé™å·²è§£é–ã€‚`;
                    
                    if (!isLevelCleared) {
                        isLevelCleared = true;
                        addMsg('ai', 'å¹¹å¾—å¥½ï¼ä»£ç¢¼é©—è­‰é€šéã€‚æº–å‚™é€²å…¥ä¸‹ä¸€å±¤ç´šã€‚');
                        // é¡¯ç¤ºä¸‹ä¸€é—œæŒ‰éˆ•
                        document.getElementById('btn-next').style.display = 'inline-block';
                    }
                }

            } catch(e) { out.innerText += "\nError: " + e; }
        }

        // ç”Ÿæˆæ–°é¡Œç›® (æŒ‰ä¸‹ä¸‹ä¸€é—œæŒ‰éˆ•è§¸ç™¼)
        async function generateNewMission() {
            const btn = document.getElementById('btn-next');
            btn.innerText = "è¼‰å…¥ä¸­...";
            btn.disabled = true;

            const prompt = `ç”Ÿæˆ Python åˆå­¸è€…é¡Œç›® JSON: { "title": "...", "story": "...", "task": "...", "default_code": "...", "validation_keyword": "..." }`;
            try {
                let res = await callGemini(prompt);
                res = res.replace(/```json/g, '').replace(/```/g, '').trim();
                const d = JSON.parse(res);
                
                document.getElementById('m-title').innerText = d.title;
                document.getElementById('m-story').innerText = d.story;
                document.getElementById('m-task').innerText = d.task;
                document.getElementById('code').value = d.default_code;
                currentValidation = d.validation_keyword;
                
                // é‡ç½®é—œå¡ç‹€æ…‹
                isLevelCleared = false;
                addMsg('ai', `ä»»å‹™æ›´æ–°ï¼š${d.title}ã€‚ç¥å¥½é‹ã€‚`);
                
                // éš±è—æŒ‰éˆ•
                btn.style.display = 'none';
                
            } catch(e) { addMsg('system', 'ç”Ÿæˆå¤±æ•—'); }
            
            // æ¢å¾©æŒ‰éˆ•æ–‡å­— (é›–ç„¶å®ƒè¢«éš±è—äº†ï¼Œé å‚™ä¸‹æ¬¡é¡¯ç¤º)
            btn.innerText = "é€²å…¥ä¸‹ä¸€é—œ â­ï¸";
            btn.disabled = false;
        }

        async function callGemini(text) {
            if(API_KEY.includes("è«‹åœ¨æ­¤")) { alert("API KEY ç¼ºå¤±"); return "{}"; }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            const res = await fetch(url, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text }] }] })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

        function addMsg(role, html) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = html;
            const box = document.getElementById('chat-box');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
