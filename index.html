<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus: æƒ…ç·’æ„ŸçŸ¥ Python è¨“ç·´</title>
    <!-- å¼•å…¥ Pyodide (Python åœ¨ç€è¦½å™¨åŸ·è¡Œ) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <!-- å¼•å…¥ face-api.js (æƒ…ç·’åµæ¸¬) -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        body {
            background-color: #0d1117;
            color: #00ff41; /* é§­å®¢ç¶  */
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* å·¦å´ï¼šéŠæˆ²èˆ‡æƒ…ç·’é¢æ¿ */
        .panel-left {
            width: 30%;
            border-right: 2px solid #333;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* è¦–è¨Šé è¦½å€ */
        #video-container {
            position: relative;
            width: 100%;
            height: 240px;
            background: #000;
            border: 2px solid #00ff41;
            margin-bottom: 20px;
            overflow: hidden;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ï¼Œè®“æ“ä½œæ¯”è¼ƒç›´è¦º */
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        /* æƒ…ç·’ç‹€æ…‹é¡¯ç¤º */
        .status-box {
            width: 100%;
            background: #161b22;
            padding: 15px;
            border: 1px solid #30363d;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        .emotion-meter {
            font-size: 1.2em;
            font-weight: bold;
        }
        .ai-message {
            margin-top: 10px;
            color: #fff;
            font-size: 0.9em;
            line-height: 1.4;
            min-height: 40px;
        }

        /* å³å´ï¼šç¨‹å¼ç¢¼ç·¨è¼¯èˆ‡åŸ·è¡Œ */
        .panel-right {
            width: 70%;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        /* é¡Œç›®å€ */
        .mission-box {
            background: #1f2428;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            color: #e6edf3;
        }

        /* ç°¡å–®çš„ç¨‹å¼ç¢¼ç·¨è¼¯å™¨ */
        #code-editor {
            flex-grow: 1;
            background-color: #0d1117;
            color: #e6edf3;
            border: 1px solid #30363d;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            resize: none;
            outline: none;
        }
        #code-editor:focus {
            border-color: #00ff41;
        }

        /* æ§åˆ¶æŒ‰éˆ• */
        .controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            transition: 0.2s;
        }
        button:hover { background: #2ea043; }
        button.secondary { background: #1f6feb; }
        button.secondary:hover { background: #388bfd; }

        /* è¼¸å‡ºçµæœ */
        #output {
            height: 150px;
            background: #000;
            border: 1px solid #333;
            margin-top: 10px;
            padding: 10px;
            color: #fff;
            white-space: pre-wrap;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <!-- å·¦å´é¢æ¿ï¼šæƒ…ç·’ç›£æ§èˆ‡ AI å°å¸« -->
    <div class="panel-left">
        <h3>STATUS MONITOR</h3>
        <div id="video-container">
            <video id="video" autoplay muted playsinline></video>
        </div>
        
        <div class="status-box">
            <div>æ¨¡å‹ç‹€æ…‹: <span id="model-status" style="color: orange;">è¼‰å…¥ä¸­...</span></div>
            <hr style="border-color: #333;">
            <div>ç•¶å‰æƒ…ç·’: <span id="current-emotion" class="emotion-meter" style="color: gray;">ç­‰å¾…åµæ¸¬</span></div>
            <br>
            <div>AI å°å¸«å»ºè­° (RAG):</div>
            <div id="ai-feedback" class="ai-message">ç³»çµ±é€£ç·šä¸­...</div>
        </div>

        <div style="font-size: 0.8em; color: gray; text-align: center;">
            *éš±ç§è²æ˜ï¼šå½±åƒåƒ…åœ¨ç€è¦½å™¨ç«¯é‹ç®—<br>ä¸æœƒä¸Šå‚³è‡³ä¼ºæœå™¨
        </div>
    </div>

    <!-- å³å´é¢æ¿ï¼šPython è¨“ç·´å ´ -->
    <div class="panel-right">
        <div class="mission-box">
            <strong>ä»»å‹™ 01: While Loop çš„è€ƒé©—</strong><br>
            è«‹å¯«ä¸€å€‹ Python è¿´åœˆï¼Œå¾ 5 å€’æ•¸åˆ° 1ï¼Œæœ€å¾Œå°å‡º "Blastoff!"ã€‚<br>
            <small>æç¤ºï¼šä½¿ç”¨ while è®Šæ•¸ > 0 ...</small>
        </div>

        <textarea id="code-editor" spellcheck="false">
# åœ¨é€™è£¡è¼¸å…¥ä½ çš„ Python ç¨‹å¼ç¢¼
count = 5
while count > 0:
    print(count)
    # é€™è£¡å¥½åƒå°‘äº†ä¸€è¡Œç¨‹å¼ç¢¼...
    # å¦‚æœä¸å¯« count = count - 1ï¼Œæœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ
        </textarea>

        <div class="controls">
            <button onclick="runPython()">åŸ·è¡Œä»£ç¢¼ (Run)</button>
            <button class="secondary" onclick="askAI()">æ±‚åŠ© AI (Simulated)</button>
        </div>

        <div id="output">ç’°å¢ƒåˆå§‹åŒ–ä¸­...</div>
    </div>

    <script>
        // --- 1. å…¨åŸŸè®Šæ•¸è¨­å®š ---
        const video = document.getElementById('video');
        const emotionSpan = document.getElementById('current-emotion');
        const aiFeedback = document.getElementById('ai-feedback');
        const modelStatus = document.getElementById('model-status');
        const outputDiv = document.getElementById('output');
        
        let pyodide = null;
        let isFrustrated = false;
        let isModelLoaded = false;

        // --- 2. å•Ÿå‹• Pyodide (Python ç’°å¢ƒ) ---
        async function initPyodide() {
            try {
                outputDiv.innerText = "æ­£åœ¨è¼‰å…¥ Python ç’°å¢ƒ (Pyodide)...";
                pyodide = await loadPyodide();
                outputDiv.innerText = "Python ç’°å¢ƒå·²å°±ç·’ï¼å¯ä»¥é–‹å§‹å¯«ç¨‹å¼äº†ã€‚\n";
            } catch (err) {
                outputDiv.innerText = "Python è¼‰å…¥å¤±æ•—: " + err;
            }
        }
        initPyodide();

        // --- 3. å•Ÿå‹• Webcam (ç«‹å³åŸ·è¡Œï¼Œä¸éœ€è¦ç­‰æ¨¡å‹) ---
        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => {
                    video.srcObject = stream;
                    console.log("æ”å½±æ©Ÿå·²å•Ÿå‹•");
                })
                .catch(err => {
                    console.error("ç„¡æ³•å­˜å–é¡é ­:", err);
                    alert("è«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨æ”å½±æ©Ÿæ¬Šé™ï¼Œå¦å‰‡ç„¡æ³•é€²è¡Œæƒ…ç·’åµæ¸¬ã€‚");
                });
        }
        startVideo();

        // --- 4. è¼‰å…¥æ¨¡å‹ (é—œéµä¿®æ­£ï¼šä½¿ç”¨é ç«¯ CDN) ---
        // é€™è£¡ç›´æ¥ä½¿ç”¨ face-api.js ä½œè€…æä¾›çš„ç·šä¸Šæ¨¡å‹åº«ï¼Œè§£æ±º 404 å•é¡Œ
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
            faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
        ]).then(() => {
            console.log("AI æ¨¡å‹è¼‰å…¥å®Œæˆï¼");
            isModelLoaded = true;
            modelStatus.innerText = "å·²é€£ç·š (Online)";
            modelStatus.style.color = "#00ff41";
            aiFeedback.innerText = "è¦–è¦ºç³»çµ±é‹ä½œæ­£å¸¸ã€‚è«‹é–‹å§‹è§£é¡Œï¼Œæˆ‘æœƒè§€å¯Ÿæ‚¨çš„ç‹€æ…‹ã€‚";
        }).catch(err => {
            console.error("æ¨¡å‹è¼‰å…¥å¤±æ•—:", err);
            modelStatus.innerText = "è¼‰å…¥å¤±æ•—";
            modelStatus.style.color = "red";
            aiFeedback.innerText = "ç„¡æ³•é€£ç·šåˆ° AI æ¨¡å‹åº«ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚";
        });

        // --- 5. å¾ªç’°åµæ¸¬é‚è¼¯ ---
        video.addEventListener('play', () => {
            const canvas = faceapi.createCanvasFromMedia(video);
            document.getElementById('video-container').append(canvas);
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            // æ¯ 500ms åµæ¸¬ä¸€æ¬¡
            setInterval(async () => {
                if (!isModelLoaded) return; // æ¨¡å‹æ²’å¥½å°±å…ˆä¸åšäº‹

                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceExpressions();
                
                // æ¸…é™¤èˆŠçš„ç•«å¸ƒ
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                
                if (detections.length > 0) {
                    // é‡æ–°èª¿æ•´å°ºå¯¸ä¸¦ç•«å‡ºæ¡†æ¡†
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    
                    // é€™è£¡æŠŠ drawDetections è¨»è§£æ‰ï¼Œå¦‚æœä½ ä¸æƒ³çœ‹åˆ°è‡‰ä¸Šçš„æ–¹æ¡†
                    // faceapi.draw.drawDetections(canvas, resizedDetections); 

                    const expressions = detections[0].expressions;
                    const sorted = Object.entries(expressions).sort((a, b) => b[1] - a[1]);
                    const topEmotion = sorted[0][0];
                    
                    updateEmotionUI(topEmotion);
                } else {
                    emotionSpan.innerText = "æœªåµæ¸¬åˆ°äººè‡‰";
                    emotionSpan.style.color = "gray";
                }
            }, 500);
        });

        // --- 6. ä»‹é¢æ›´æ–°èˆ‡æ¨¡æ“¬ RAG ---
        function updateEmotionUI(emotion) {
            let label = "";
            let color = "white";

            // ç¿»è­¯ä¸¦è¨­å®šé¡è‰²
            switch(emotion) {
                case 'happy': label = "é–‹å¿ƒ/è‡ªä¿¡ (Flow)"; color = "#00ff41"; isFrustrated = false; break;
                case 'sad': label = "æŒ«æŠ˜/å›°æƒ‘ (Sad)"; color = "#ff4444"; isFrustrated = true; break;
                case 'angry': label = "æ†¤æ€’/ç„¦æ…® (Angry)"; color = "#ff4444"; isFrustrated = true; break;
                case 'neutral': label = "å¹³éœ/å°ˆæ³¨ (Neutral)"; color = "#00ffff"; isFrustrated = false; break;
                case 'surprised': label = "é©šè¨ (Surprised)"; color = "yellow"; isFrustrated = false; break;
                default: label = emotion; color = "white";
            }

            emotionSpan.textContent = label;
            emotionSpan.style.color = color;
        }

        async function runPython() {
            if (!pyodide) return;
            const code = document.getElementById('code-editor').value;
            
            outputDiv.innerText = ">>> åŸ·è¡Œä¸­...\n";

            try {
                // é‡å°å‘ stdout ä»¥é¡¯ç¤º print çµæœ
                pyodide.setStdout({ batched: (msg) => { outputDiv.innerText += msg + "\n"; } });
                await pyodide.runPythonAsync(code);
            } catch (err) {
                outputDiv.innerText += "éŒ¯èª¤ (Error): \n" + err;
                aiFeedback.innerText = "ç¨‹å¼ç¢¼ç™¼ç”ŸéŒ¯èª¤ï¼åˆ¥ç°å¿ƒï¼Œçœ‹çœ‹éŒ¯èª¤è¨Šæ¯ï¼Œæ˜¯ä¸æ˜¯æ‹¼å­—éŒ¯äº†ï¼Ÿ";
            }
        }

        function askAI() {
            const code = document.getElementById('code-editor').value;
            aiFeedback.innerText = "AI æ­£åœ¨åˆ†ææ‚¨çš„ä»£ç¢¼é‚è¼¯èˆ‡æƒ…ç·’æ•¸æ“š...";
            
            setTimeout(() => {
                let response = "";
                
                // æ¨¡æ“¬ RAG çŸ¥è­˜åº«åˆ¤æ–·
                if (code.includes("while") && !code.includes("count = count - 1") && !code.includes("count -= 1")) {
                    response = "âš ï¸ [AI è­¦å‘Š]: æˆ‘ç™¼ç¾ä½ çš„è¿´åœˆå¥½åƒæ²’æœ‰è®“ count è®Šå°ã€‚é€™æ¨£ count æ°¸é å¤§æ–¼ 0ï¼Œæœƒè®Šæˆã€Œç„¡çª®è¿´åœˆã€ç•¶æ©Ÿå–”ï¼è©¦è‘—åŠ å…¥æ¸›æ³•é‹ç®—ã€‚";
                } else if (isFrustrated) {
                    response = "ğŸ˜Ÿ [AI é—œæ‡·]: åµæ¸¬åˆ°æ‚¨ä¼¼ä¹æœ‰é»ç„¦æ…®ã€‚é€™é¡Œçš„é—œéµæ˜¯ã€ŒWhileã€åªè¦æ¢ä»¶æˆç«‹å°±æœƒä¸€ç›´è·‘ã€‚å»ºè­°æ‚¨å¯ä»¥å…ˆç”¨ `print(count)` ä¾†è§€å¯Ÿè®Šæ•¸è®ŠåŒ–ã€‚";
                } else {
                    response = "ğŸ¤– [AI å°å¸«]: ç›®å‰çœ‹èµ·ä¾†é‚è¼¯æ–¹å‘æ­£ç¢ºï¼å¦‚æœåŸ·è¡Œçµæœä¸å¦‚é æœŸï¼Œå¯ä»¥æª¢æŸ¥ä¸€ä¸‹ç¸®æ’ (Indentation)ã€‚";
                }
                
                aiFeedback.innerText = response;
            }, 1000);
        }
    </script>
</body>
</html>
