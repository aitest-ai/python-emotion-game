<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus: æƒ…ç·’æ„ŸçŸ¥èˆ‡æ“¬é¡Œäº’è©•ç³»çµ± (v6.0)</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #050505; --panel-bg: #101010; --accent: #00ff9d; --accent-dim: #005533;
            --danger: #ff3333; --warning: #ffcc00; --text: #e0e0e0; --border: #333;
        }
        body { background: var(--bg-color); color: var(--text); font-family: 'Microsoft JhengHei', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .panel-left { width: 300px; background: var(--panel-bg); border-right: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; }
        .panel-right { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; position: relative; }

        /* Camera & Status */
        .cam-box { height: 180px; background: #000; border: 2px solid var(--accent); border-radius: 6px; overflow: hidden; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .status-box { background: #1a1a1a; padding: 10px; margin-top: 10px; border-radius: 6px; border: 1px solid #333; font-size: 0.9em; }
        .val { font-weight: bold; color: var(--accent); }

        /* Logger (Research Data) */
        #log-box { flex-grow: 1; background: #000; margin-top: 10px; padding: 5px; font-family: monospace; font-size: 0.8em; color: #888; overflow-y: auto; border: 1px solid #333; }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #222; }

        /* Navigation Tabs (Phases) */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { background: #222; border: 1px solid #444; color: #aaa; padding: 8px 15px; cursor: pointer; border-radius: 4px; transition: 0.3s; }
        .tab-btn.active { background: var(--accent-dim); color: white; border-color: var(--accent); }

        /* Dynamic Content Area */
        .content-area { flex-grow: 1; display: none; flex-direction: column; animation: fadeIn 0.5s; }
        .content-area.active { display: flex; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--accent); font-weight: bold; }
        input, textarea { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 100px; resize: vertical; font-family: monospace; }

        /* Editor */
        #editor-wrapper { flex-grow: 1; border: 1px solid #333; border-radius: 6px; overflow: hidden; display: flex; flex-direction: column; }
        #code-editor { flex-grow: 1; background: #0c0c0c; color: #ddd; padding: 15px; font-family: monospace; border: none; outline: none; resize: none; font-size: 14px; }
        
        /* Chat */
        #chat-panel { height: 200px; border-top: 1px solid #333; background: #080808; display: flex; flex-direction: column; padding: 10px; }
        #chat-msgs { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; }
        .msg { padding: 5px 10px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9em; }
        .msg.ai { color: var(--accent); background: #112211; }
        .msg.user { color: #fff; background: #222; align-self: flex-end; }

        button { background: var(--accent-dim); color: white; border: 1px solid var(--accent); padding: 8px 20px; cursor: pointer; border-radius: 4px; }
        button:hover { background: var(--accent); color: black; }

        /* Scoring Table */
        .score-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .score-table td, .score-table th { border: 1px solid #333; padding: 8px; text-align: center; }
        .score-table th { background: #222; color: var(--accent); }
    </style>
</head>
<body>

    <!-- å·¦å´ï¼šç›£æ§èˆ‡æ•¸æ“š -->
    <div class="panel-left">
        <h3 style="color:var(--accent); margin:0 0 10px 0;">Code Nexus v6.0</h3>
        <div class="cam-box"><video id="video" autoplay muted playsinline></video></div>
        
        <div class="status-box">
            <div>æƒ…ç·’ (EM): <span id="emo-val" class="val">Detecting...</span></div>
            <div>è¡Œç‚º (Action): <span id="action-val" style="color:yellow;">--</span></div>
        </div>

        <h4 style="margin:15px 0 5px 0; color:#666;">å­¸ç¿’è¡Œç‚ºæ—¥èªŒ (Log)</h4>
        <div id="log-box"></div>
    </div>

    <!-- å³å´ï¼šä¸»è¦æ“ä½œå€ -->
    <div class="panel-right">
        
        <!-- éšæ®µå°èˆª (Phase Navigation) -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchPhase('learning')">1. å­¸ç¿’ (LN)</button>
            <button class="tab-btn" onclick="switchPhase('posing')">2. æ“¬é¡Œ (PP)</button>
            <button class="tab-btn" onclick="switchPhase('peer')">3. äº’è©• (PA)</button>
            <button class="tab-btn" onclick="switchPhase('reflection')">4. åæ€ (RF)</button>
        </div>

        <!-- 1. å­¸ç¿’æ¨¡å¼ (Learning) -->
        <div id="phase-learning" class="content-area active">
            <div style="background:#151515; padding:20px; border-radius:8px; border-left:4px solid var(--accent);">
                <h2>ğŸ“ å–®å…ƒï¼šPython æ¢ä»¶åˆ¤æ–· (if-else)</h2>
                <p>è«‹é–±è®€ä»¥ä¸‹æ•™æï¼Œä¸¦å˜—è©¦ç†è§£ `if` èˆ‡ `else` çš„é‚è¼¯ã€‚</p>
                <pre style="background:#222; padding:10px; color:#aaa;">
score = 80
if score >= 60:
    print("åŠæ ¼")
else:
    print("ä¸åŠæ ¼")
                </pre>
                <button onclick="logAction('LN', 'é–±è®€æ•™æå®Œç•¢')">æˆ‘å·²é–±è®€å®Œç•¢ï¼Œé€²å…¥æ“¬é¡Œ</button>
            </div>
        </div>

        <!-- 2. æ“¬é¡Œæ¨¡å¼ (Problem Posing) -->
        <div id="phase-posing" class="content-area">
            <div style="display:flex; gap:20px; height:100%;">
                <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                    <h3>æˆ‘è¦å‡ºé¡Œ</h3>
                    <input id="pp-title" placeholder="é¡Œç›®åç¨± (ä¾‹ï¼šåˆ¤æ–·æˆå¹´)">
                    <textarea id="pp-desc" placeholder="é¡Œç›®æ•˜è¿° (ä¾‹ï¼šè«‹å¯«ä¸€å€‹ç¨‹å¼ï¼Œè¼¸å…¥å¹´é½¡ï¼Œè‹¥å¤§æ–¼18å°å‡º Adult...)"></textarea>
                    <input id="pp-input" placeholder="è¼¸å…¥ç¯„ä¾‹ (ä¾‹ï¼š20)">
                    <input id="pp-output" placeholder="è¼¸å‡ºç¯„ä¾‹ (ä¾‹ï¼šAdult)">
                </div>
                <div style="flex:1; display:flex; flex-direction:column;">
                    <h3>æ¨™æº–è§£ç­”ç¨‹å¼ç¢¼</h3>
                    <div id="editor-wrapper">
                        <textarea id="code-editor" placeholder="# è«‹åœ¨æ­¤æ’°å¯«æ‚¨çš„æ¨™æº–è§£ç­”..."></textarea>
                    </div>
                    <div style="margin-top:10px; text-align:right;">
                        <button onclick="submitProblem()">æäº¤é¡Œç›® (Submit)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. åŒå„•äº’è©•æ¨¡å¼ (Peer Assessment) -->
        <div id="phase-peer" class="content-area">
            <h3>ğŸ¤– AI åŒå„•çš„å›é¥‹èˆ‡è©•åˆ†</h3>
            <p id="peer-feedback-text">è«‹å…ˆåœ¨ã€Œæ“¬é¡Œéšæ®µã€æäº¤é¡Œç›®ï¼ŒAI åŒå­¸å°‡æœƒå°æ‚¨çš„é¡Œç›®é€²è¡Œè©•æ¸¬ã€‚</p>
            
            <div id="peer-result" style="display:none;">
                <table class="score-table">
                    <tr><th>è©•åˆ†å‘åº¦ (1-4åˆ†)</th><th>å¾—åˆ†</th><th>AI è©•èª</th></tr>
                    <tr><td>é¡Œç›®æ­£ç¢ºæ€§</td><td id="score-1">-</td><td rowspan="5" id="score-comment" style="text-align:left; vertical-align:top;"></td></tr>
                    <tr><td>é¡Œç›®è¤‡é›œæ€§</td><td id="score-2">-</td></tr>
                    <tr><td>é¡Œç›®å¯¦ç”¨æ€§</td><td id="score-3">-</td></tr>
                    <tr><td>ç¨‹å¼æ­£ç¢ºæ€§</td><td id="score-4">-</td></tr>
                    <tr><td>ç¨‹å¼å¯è®€æ€§</td><td id="score-5">-</td></tr>
                </table>
            </div>
        </div>

        <!-- 4. åæ€æ¨¡å¼ (Reflection) -->
        <div id="phase-reflection" class="content-area">
            <h3>ğŸ¤” åæ€èˆ‡ä¿®æ­£</h3>
            <p>æ ¹æ“š AI åŒå„•çš„å›é¥‹ï¼Œæ‚¨è¦ºå¾—é¡Œç›®å¯ä»¥æ€éº¼æ”¹å¾—æ›´å¥½ï¼Ÿ</p>
            <textarea id="rf-note" placeholder="åœ¨æ­¤è¼¸å…¥æ‚¨çš„åæ€å¿ƒå¾—..."></textarea>
            <div style="margin-top:10px;">
                <button onclick="logAction('RF', 'æäº¤åæ€')">å®Œæˆæœ¬å–®å…ƒ</button>
            </div>
        </div>

        <!-- åº•éƒ¨èŠå¤©èˆ‡æç¤ºå€ -->
        <div id="chat-panel">
            <div id="chat-msgs">
                <div class="msg ai">ç³»çµ±ï¼šæ­¡è¿é€²å…¥æƒ…ç·’åµæ¸¬å­¸ç¿’ç³»çµ±ã€‚è«‹å…ˆé–±è®€æ•™æã€‚</div>
            </div>
            <div style="display:flex; gap:10px;">
                <input id="chat-input" type="text" placeholder="è·Ÿ AI å¤¥ä¼´è¨è«–..." onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()">ç™¼é€</button>
            </div>
        </div>

    </div>

    <script>
        // ================= Configuration =================
        const API_KEY = "è«‹åœ¨æ­¤å¡«å…¥ä½ çš„API_KEY"; // âš ï¸ è«‹å¡«å…¥ Key
        // ===============================================

        let currentPhase = 'learning';
        let emotionHistory = [];
        let isFaceLoaded = false;

        // å•Ÿå‹•ç³»çµ±
        async function init() {
            logAction('SYS', 'ç³»çµ±å•Ÿå‹•');
            // Face API
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
            ]);
            isFaceLoaded = true;
            
            const video = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            video.addEventListener('play', () => setInterval(detectEmotion, 1000));
        }
        init();

        // 1. æƒ…ç·’åµæ¸¬ (æ¯ç§’)
        async function detectEmotion() {
            if(!isFaceLoaded) return;
            const video = document.getElementById('video');
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            
            if(detections.length > 0) {
                const ex = detections[0].expressions;
                const top = Object.entries(ex).sort((a,b) => b[1]-a[1])[0][0];
                
                document.getElementById('emo-val').innerText = top;
                logAction('EM', top); // ç´€éŒ„æƒ…ç·’æ•¸æ“š

                // è² é¢æƒ…ç·’ä»‹å…¥é‚è¼¯ (PDF é‡é»)
                if(['sad', 'angry', 'fearful'].includes(top)) {
                    emotionHistory.push(top);
                    if(emotionHistory.length >= 5) { // é€£çºŒ 5 ç§’è² é¢
                        triggerAIIntervention();
                        emotionHistory = [];
                    }
                } else {
                    emotionHistory = []; // é‡ç½®
                }
            }
        }

        // 2. AI æ¼¸é€²å¼ä»‹å…¥
        function triggerAIIntervention() {
            addMsg('ai', 'âš ï¸ åµæ¸¬åˆ°æ‚¨ä¼¼ä¹æœ‰äº›å›°æ“¾ã€‚éœ€è¦æç¤ºå—ï¼Ÿ(IS)');
            logAction('AI_Trigger', 'è² é¢æƒ…ç·’ä»‹å…¥');
        }

        // 3. æ“¬é¡Œæäº¤ (Problem Posing)
        async function submitProblem() {
            const title = document.getElementById('pp-title').value;
            const desc = document.getElementById('pp-desc').value;
            const code = document.getElementById('code-editor').value;

            if(!title || !code) { alert("è«‹å¡«å¯«å®Œæ•´é¡Œç›®èˆ‡ç¨‹å¼ç¢¼"); return; }

            logAction('PP', `æäº¤é¡Œç›®: ${title}`);
            addMsg('user', `æäº¤é¡Œç›®ï¼š${title}`);
            addMsg('ai', 'AI åŒå­¸æ­£åœ¨è©•åˆ†æ‚¨çš„é¡Œç›® (PA)...');

            // å‘¼å« Gemini é€²è¡Œäº’è©•æ¨¡æ“¬
            const prompt = `
            ä½ ç¾åœ¨æ‰®æ¼”ä¸€ä½ç¨‹å¼è¨­è¨ˆçš„åˆå­¸è€…åŒå­¸ (Peer)ã€‚
            è«‹å°æˆ‘å‡ºçš„é¡Œç›®é€²è¡Œã€ŒåŒå„•äº’è©•ã€ã€‚
            æˆ‘çš„é¡Œç›®ï¼š${title}
            æ•˜è¿°ï¼š${desc}
            åƒè€ƒè§£ç­”ï¼š${code}

            è«‹é‡å°ä»¥ä¸‹ 5 é»çµ¦åˆ† (1-4åˆ†)ï¼Œä¸¦çµ¦æˆ‘ä¸€æ®µè©•èª(ç¹é«”ä¸­æ–‡)ï¼š
            1. é¡Œç›®æ­£ç¢ºæ€§
            2. é¡Œç›®è¤‡é›œæ€§
            3. é¡Œç›®å¯¦ç”¨æ€§
            4. ç¨‹å¼æ­£ç¢ºæ€§
            5. ç¨‹å¼å¯è®€æ€§

            è«‹å›å‚³ JSON æ ¼å¼ï¼š
            {
                "scores": [4, 3, 4, 4, 3],
                "comment": "ä½ çš„é¡Œç›®å¾ˆæœ‰è¶£ï¼Œä½†æ˜¯è®Šæ•¸å‘½åå¯ä»¥æ›´æ¸…æ¥šä¸€é»..."
            }
            `;

            try {
                const res = await callGemini(prompt);
                const json = JSON.parse(extractJSON(res));
                
                // é¡¯ç¤ºè©•åˆ†çµæœ
                document.getElementById('peer-result').style.display = 'block';
                for(let i=0; i<5; i++) {
                    document.getElementById(`score-${i+1}`).innerText = json.scores[i];
                }
                document.getElementById('score-comment').innerText = json.comment;
                
                logAction('PA', 'æ”¶åˆ° AI åŒå„•è©•åˆ†');
                switchPhase('peer'); // è‡ªå‹•è·³è½‰åˆ°äº’è©•é 

            } catch(e) {
                console.error(e);
                addMsg('ai', 'è©•åˆ†ç³»çµ±é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚');
            }
        }

        // 4. éšæ®µåˆ‡æ›èˆ‡æ—¥èªŒç´€éŒ„
        function switchPhase(phase) {
            currentPhase = phase;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.content-area').forEach(d => d.classList.remove('active'));
            
            // Highlight Tab & Show Content
            const btnIndex = {'learning':0, 'posing':1, 'peer':2, 'reflection':3}[phase];
            document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
            document.getElementById(`phase-${phase}`).classList.add('active');

            logAction('NAV', `åˆ‡æ›è‡³éšæ®µ: ${phase}`);
        }

        // 5. è¡Œç‚ºæ•¸æ“šç´€éŒ„ (Logger) - å°æ‡‰ PDF è¡Œç‚ºåˆ†æ
        function logAction(type, detail) {
            const time = new Date().toLocaleTimeString();
            const logBox = document.getElementById('log-box');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerText = `[${time}] ${type}: ${detail}`;
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
            
            // TODO: åœ¨çœŸå¯¦ç³»çµ±ä¸­ï¼Œé€™è£¡æœƒå°‡æ•¸æ“š POST åˆ°å¾Œç«¯è³‡æ–™åº«
        }

        // Helper: Call Gemini
        async function callGemini(text) {
            if(API_KEY.includes("è«‹åœ¨æ­¤")) { alert("è«‹è¨­å®š API Key"); return "{}"; }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
            const res = await fetch(url, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text }] }] })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

        function extractJSON(str) {
            const s = str.indexOf('{'); const e = str.lastIndexOf('}');
            return (s!==-1 && e!==-1) ? str.substring(s, e+1) : "{}";
        }

        function addMsg(role, text) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerText = text;
            document.getElementById('chat-msgs').appendChild(div);
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const val = input.value;
            if(!val) return;
            addMsg('user', val);
            input.value = "";
            logAction('EX', `èˆ‡ AI å°è©±: ${val}`); // EX = Explore/Chat
            // é€™è£¡å¯ä»¥æ¥ä¸Š Gemini åšä¸€èˆ¬å°è©±
        }

    </script>
</body>
</html>
