<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus: AI æƒ…å¢ƒå¼å­¸ç¿’ç³»çµ± (v5.0)</title>
    <!-- å¼•å…¥æ ¸å¿ƒåº« -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #101010;
            --accent: #00ff9d; /* Cyber Green */
            --accent-dim: #005533;
            --danger: #ff3333;
            --border: #333;
            --text: #e0e0e0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text);
            font-family: 'Segoe UI', 'Microsoft JhengHei', monospace;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- å·¦å´ç›£æ§èˆ‡èŠå¤© --- */
        .panel-left {
            width: 320px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
            z-index: 10;
        }

        .cam-box {
            height: 200px;
            background: #000;
            border: 2px solid var(--accent);
            border-radius: 6px;
            position: relative;
            margin-bottom: 10px;
            overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .status-box {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #222;
        }

        .metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; }
        .val { font-weight: bold; color: var(--accent); }
        .val.bad { color: var(--danger); }

        /* å£“åŠ›æ¢ */
        .stress-bar-bg {
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        .stress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent);
            transition: width 0.5s ease-out, background 0.5s;
        }

        /* èŠå¤©å®¤ */
        #chat-box {
            flex-grow: 1;
            background: #080808;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .msg { padding: 10px; border-radius: 8px; font-size: 0.9em; line-height: 1.5; max-width: 90%; word-wrap: break-word; }
        .msg.ai { background: #1a2a1a; border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.user { background: #004455; align-self: flex-end; }
        .msg.system { background: transparent; color: #666; font-size: 0.8em; text-align: center; align-self: center; border: none; padding: 0;}

        #chat-input {
            background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px; margin-top: 10px; border-radius: 4px; width: 100%; box-sizing: border-box;
        }

        /* --- å³å´ä»»å‹™èˆ‡ä»£ç¢¼ --- */
        .panel-right {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ä»»å‹™å¡ç‰‡ (AI å‹•æ…‹ç”Ÿæˆ) */
        .mission-card {
            background: #151515;
            border-left: 5px solid var(--accent);
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        .mission-header { display: flex; justify-content: space-between; align-items: center; }
        .mission-title { font-size: 1.5em; margin: 0; color: white; }
        .mission-story { color: #bbb; margin-top: 10px; line-height: 1.6; font-style: italic; }
        .mission-task { background: #222; padding: 10px; margin-top: 10px; border-radius: 4px; color: var(--accent); font-family: monospace; }

        .btn-gen { background: #333; color: #ddd; border: 1px solid #555; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8em; }
        .btn-gen:hover { background: #444; }

        /* ç·¨è¼¯å™¨ */
        #editor-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: filter 0.8s;
        }
        
        textarea {
            flex-grow: 1;
            background: #0c0c0c;
            color: #dcdcdc;
            border: none;
            padding: 20px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }

        .editor-footer {
            background: #1a1a1a;
            padding: 10px;
            display: flex;
            justify-content: flex-end;
            border-top: 1px solid #333;
        }

        .btn-run {
            background: var(--accent-dim);
            color: #fff;
            border: 1px solid var(--accent);
            padding: 8px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: 0.2s;
        }
        .btn-run:hover { background: var(--accent); color: #000; }

        #output {
            height: 120px;
            background: #000;
            color: #aaa;
            padding: 15px;
            font-family: monospace;
            border-top: 1px solid #333;
            white-space: pre-wrap;
            overflow-y: auto;
        }

        /* æ²»ç™‚æ¨¡å¼ (Overlay) */
        #therapy-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.95);
            z-index: 999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        .therapy-box {
            width: 500px;
            padding: 40px;
            border: 2px solid var(--danger);
            border-radius: 12px;
            background: #111;
            box-shadow: 0 0 50px rgba(255, 50, 50, 0.15);
        }
        .therapy-text { font-size: 1.2em; margin: 20px 0; color: #eee; min-height: 60px; }
        
        .btn-resume {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            padding: 10px 30px; margin-top: 20px; cursor: pointer; opacity: 0; transition: 1s;
        }

    </style>
</head>
<body>

    <!-- å·¦å´é¢æ¿ -->
    <div class="panel-left">
        <h3 style="color:var(--accent); text-align:center; letter-spacing:1px; margin-top:0;">NEXUS v5.0</h3>
        
        <div class="cam-box">
            <video id="video" autoplay muted playsinline></video>
        </div>

        <div class="status-box">
            <div class="metric-row">
                <span>æƒ…ç·’ç‹€æ…‹:</span>
                <span id="emo-val" class="val">æƒæä¸­...</span>
            </div>
            <div class="metric-row">
                <span>æ–‡å­—æƒ…ç·’:</span>
                <span id="text-sentiment-val" class="val" style="color:gray;">--</span>
            </div>
            
            <div style="margin-top:10px; font-size:0.8em; color:gray;">ç²¾ç¥è² è¼‰ (Stress Level)</div>
            <div class="stress-bar-bg">
                <div id="stress-bar" class="stress-bar"></div>
            </div>
        </div>

        <div id="chat-box">
            <div class="msg ai">é§­å®¢ä½ å¥½ã€‚æˆ‘æ˜¯ä½ çš„ AI æˆ°è¡“é¡§å•ã€‚æ­£åœ¨åˆå§‹åŒ–å­¸ç¿’ç’°å¢ƒ...</div>
        </div>
        <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯... (Enter é€å‡º)" onkeypress="if(event.key==='Enter') sendChat()">
    </div>

    <!-- å³å´é¢æ¿ -->
    <div class="panel-right">
        
        <!-- æ²»ç™‚é®ç½© -->
        <div id="therapy-overlay">
            <div class="therapy-box">
                <h2 style="color: var(--danger); margin:0;">âš ï¸ ç³»çµ±éç†±è­¦å‘Š</h2>
                <p style="color:#888;">åµæ¸¬åˆ°é«˜å£“æƒ…ç·’åæ‡‰ã€‚å­¸ç¿’å”å®šå·²æš«åœã€‚</p>
                <hr style="border-color:#333; margin:20px 0;">
                <div id="ai-therapy-text" class="therapy-text">AI æ­£åœ¨é€£ç·š...</div>
                <button id="btn-resume" class="btn-resume" onclick="closeTherapy()">æˆ‘æº–å‚™å¥½äº†ï¼Œç¹¼çºŒä»»å‹™ â–¶</button>
            </div>
        </div>

        <!-- ä»»å‹™å¡ç‰‡ -->
        <div class="mission-card" id="mission-card">
            <div class="mission-header">
                <h2 class="mission-title" id="m-title">Level 0: ç³»çµ±æ ¡æº–</h2>
                <button class="btn-gen" onclick="generateNewMission()">ğŸ”„ ç”Ÿæˆæ–°æŒ‘æˆ°</button>
            </div>
            <div class="mission-story" id="m-story">æˆ‘å€‘éœ€è¦ç¢ºèªä½ çš„ Python çµ‚ç«¯æ©Ÿé‹ä½œæ­£å¸¸ã€‚è«‹å‘ä¸»æ©Ÿç™¼é€è¨Šè™Ÿã€‚</div>
            <div class="mission-task" id="m-task">ä»»å‹™ï¼šè«‹ä½¿ç”¨ print("Link Start") å°å‡ºè¨Šè™Ÿã€‚</div>
        </div>

        <!-- ç·¨è¼¯å™¨ -->
        <div id="editor-wrapper">
            <textarea id="code" spellcheck="false" placeholder="# åœ¨æ­¤è¼¸å…¥ Python ä»£ç¢¼..."></textarea>
            <div class="editor-footer">
                <button class="btn-run" onclick="runPythonCode()">â–¶ åŸ·è¡Œä»£ç¢¼ (RUN)</button>
            </div>
            <div id="output">ç­‰å¾…æŒ‡ä»¤...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”‘ API KEY è¨­å®š (è«‹å‹™å¿…å¡«å¯«)
        // ==========================================
        const API_KEY = "AIzaSyA2k88qSlo4mcuWkjoLBf9Yeb-v4BXgaco"; 
        const MODEL_NAME = "gemini-2.5-flash"; // Google å®˜æ–¹ç©©å®šç‰ˆ
        // ==========================================

        // --- æ ¸å¿ƒè®Šæ•¸ ---
        let pyodide = null;
        let isModelLoaded = false;
        let isTherapy = false;
        let stressScore = 0;
        let currentValidation = "Link Start"; // ç•¶å‰é—œå¡çš„éé—œé—œéµå­—
        
        // æ»‘å‹•çª—å£ (æƒ…ç·’)
        const EMO_WINDOW = 20;
        let emoHistory = [];

        // è¡Œç‚ºè¿½è¹¤
        let textNegativeScore = 0; // æ–‡å­—è² é¢æŒ‡æ•¸
        let lastActivity = Date.now();

        // åˆå§‹åŒ–
        async function initSystem() {
            const out = document.getElementById('output');
            
            // 1. è¼‰å…¥ Pyodide
            try {
                out.innerText = ">>> è¼‰å…¥ Python æ ¸å¿ƒä¸­...";
                pyodide = await loadPyodide();
                out.innerText = ">>> Python æ ¸å¿ƒå°±ç·’ã€‚\n>>> æ­£åœ¨å•Ÿå‹•è¦–è¦ºæ¨¡çµ„...";
            } catch(e) {
                out.innerText = "Python è¼‰å…¥å¤±æ•—: " + e;
            }

            // 2. è¼‰å…¥ Face API
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
            ]);
            isModelLoaded = true;

            // 3. å•Ÿå‹• Webcam
            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                video.addEventListener('play', () => {
                    setInterval(monitorLoop, 500); // å•Ÿå‹•ä¸»ç›£æ§å¾ªç’°
                });
                out.innerText = ">>> ç³»çµ±å…¨æ•¸é‹ä½œæ­£å¸¸ã€‚\n>>> ç­‰å¾…è¼¸å…¥...";
            } catch(e) {
                out.innerText += "\n[è­¦å‘Š] ç„¡æ³•å­˜å–æ”å½±æ©Ÿã€‚";
            }
        }
        initSystem(); // åŸ·è¡Œåˆå§‹åŒ–

        // --- ğŸ§  ä¸»ç›£æ§å¾ªç’° (Monitor Loop) ---
        async function monitorLoop() {
            if (!isModelLoaded || isTherapy) return;

            // 1. åµæ¸¬è¡¨æƒ…
            const video = document.getElementById('video');
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            
            let isBadFace = 0;
            let label = "åµæ¸¬ä¸­...";
            let color = "gray";

            if (detections.length > 0) {
                const ex = detections[0].expressions;
                const sorted = Object.entries(ex).sort((a,b) => b[1]-a[1]);
                const top = sorted[0][0];

                // ä¸­æ–‡åŒ–å°æ˜ 
                const map = {
                    'happy': {t:'é–‹å¿ƒ/è‡ªä¿¡', c:'#00ff9d'},
                    'neutral': {t:'å¹³éœ/å°ˆæ³¨', c:'#00ccff'},
                    'sad': {t:'æŒ«æŠ˜/ç–²æ†Š', c:'#ff3333'},
                    'angry': {t:'ç”Ÿæ°£/ç„¦æ…®', c:'#ff3333'},
                    'fearful': {t:'ç·Šå¼µ', c:'orange'},
                    'surprised': {t:'é©šè¨', c:'yellow'}
                };
                
                const info = map[top] || {t:top, c:'white'};
                label = info.t;
                color = info.c;

                // åˆ¤æ–·è² é¢
                if (['sad', 'angry', 'fearful', 'disgusted'].includes(top)) isBadFace = 1;
            }

            // æ›´æ–° UI
            const emoEl = document.getElementById('emo-val');
            emoEl.innerText = label;
            emoEl.style.color = color;

            // æ›´æ–°æ­·å²çª—å£
            emoHistory.push(isBadFace);
            if(emoHistory.length > EMO_WINDOW) emoHistory.shift();

            // 2. è¨ˆç®—å£“åŠ›å€¼
            calculateStress();
        }

        // --- ğŸ“Š å£“åŠ›è¨ˆç®—é‚è¼¯ ---
        function calculateStress() {
            // A. è¡¨æƒ…å£“åŠ› (ä½”æ¯”é‡)
            const badCount = emoHistory.reduce((a,b)=>a+b, 0);
            const faceStress = (badCount / emoHistory.length) * 100; // 0~100

            // B. æ–‡å­—å£“åŠ› (å¦‚æœå­¸ç”Ÿç½µé«’è©±æˆ–å–Šé›£) - æœƒéš¨æ™‚é–“éæ¸›
            if(textNegativeScore > 0) textNegativeScore -= 0.5;

            // ç¶œåˆè¨ˆç®—
            // è‡‰éƒ¨ä½” 50%, æ–‡å­—æƒ…ç·’ä½” 50% (å› ç‚ºå­¸ç”Ÿæ‰“å­—æŠ±æ€¨é€šå¸¸æ˜¯çœŸçš„ä¸æƒ³å­¸äº†)
            stressScore = (faceStress * 0.5) + Math.min(100, textNegativeScore);

            // UI æ›´æ–°
            const bar = document.getElementById('stress-bar');
            bar.style.width = Math.min(100, stressScore) + "%";
            
            // é¡è‰²è®ŠåŒ–
            if(stressScore < 40) bar.style.background = "#00ff9d";
            else if(stressScore < 75) bar.style.background = "orange";
            else bar.style.background = "#ff3333";

            // è§¸ç™¼æ²»ç™‚ (é–¾å€¼ 80)
            if(stressScore > 80) {
                triggerTherapy();
            }
        }

        // --- ğŸ“ æ–‡å­—æƒ…ç·’åˆ†æ (ç°¡æ˜“ç‰ˆ + AI è¼”åŠ©) ---
        function analyzeTextSentiment(text) {
            // ç°¡æ˜“é—œéµå­—åŒ¹é… (å¿«é€Ÿåæ‡‰)
            const negativeWords = ['é›£', 'ä¸æœƒ', 'ç…©', 'çˆ›', 'è¨å­', 'æ”¾æ£„', 'çœ‹ä¸æ‡‚', 'error', 'å¤±æ•—'];
            let hit = false;
            negativeWords.forEach(w => {
                if(text.includes(w)) hit = true;
            });

            if(hit) {
                textNegativeScore += 30; // å£“åŠ›æš´å¢
                document.getElementById('text-sentiment-val').innerText = "è² é¢ (Negative)";
                document.getElementById('text-sentiment-val').className = "val bad";
            } else {
                document.getElementById('text-sentiment-val').innerText = "ä¸­æ€§ (Neutral)";
                document.getElementById('text-sentiment-val').className = "val";
            }
        }

        // --- ğŸ¤– AI ç›¸é—œåŠŸèƒ½ ---

        // 1. ä¸€èˆ¬èŠå¤©
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if(!text) return;

            // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
            addMsg('user', text);
            input.value = "";
            
            // åˆ†ææƒ…ç·’
            analyzeTextSentiment(text);

            // å‘¼å« AI
            addMsg('system', 'AI æ€è€ƒä¸­...');
            
            const codeContext = document.getElementById('code').value;
            const prompt = `
            ä½ æ˜¯ Code Nexus çš„ AI æˆ°è¡“é¡§å•ã€‚
            å­¸ç”Ÿæ­£åœ¨è§£é¡Œï¼š${document.getElementById('m-title').innerText}
            å­¸ç”Ÿç¨‹å¼ç¢¼ï¼š${codeContext}
            å­¸ç”Ÿè¨Šæ¯ï¼š${text}
            è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œä»¥ã€Œæˆ°è¡“é¡§å•ã€çš„èªæ°£ç°¡çŸ­å›ç­”ã€‚å¦‚æœå­¸ç”Ÿæ„Ÿåˆ°æŒ«æŠ˜ï¼Œè«‹çµ¦äºˆé¼“å‹µã€‚
            `;
            
            const reply = await callGemini(prompt);
            document.querySelector('#chat-box .msg.system').remove(); // ç§»é™¤ "æ€è€ƒä¸­"
            addMsg('ai', marked.parse(reply));
        }

        // 2. å‹•æ…‹ç”Ÿæˆé¡Œç›® (æ ¸å¿ƒåŠŸèƒ½)
        async function generateNewMission() {
            const btn = document.querySelector('.btn-gen');
            btn.innerText = "ç”Ÿæˆä¸­...";
            btn.disabled = true;

            const prompt = `
            è«‹æ‰®æ¼”ä¸€å€‹è³½åšé¾å…‹ (Cyberpunk) é¢¨æ ¼çš„ç¨‹å¼å°å¸«ã€‚
            è«‹ã€Œç”Ÿæˆä¸€å€‹ã€Python åˆå­¸è€…é¡Œç›®ã€‚
            
            è«‹åš´æ ¼éµå®ˆä»¥ä¸‹ JSON æ ¼å¼å›å‚³ï¼Œä¸è¦æœ‰ markdown æ¨™è¨˜ï¼š
            {
                "title": "ä»»å‹™æ¨™é¡Œ",
                "story": "ä¸€æ®µ 30 å­—ä»¥å…§çš„ç§‘å¹»æƒ…å¢ƒæè¿° (ä¾‹å¦‚é§­å…¥çµ‚ç«¯æ©Ÿã€ä¿®å¾©æ©Ÿå™¨äºº)",
                "task": "å…·é«”çš„ç¨‹å¼ä»»å‹™èªªæ˜ (ä¾‹å¦‚ç”¨ print å°å‡ºä»€éº¼ï¼Œæˆ–æ˜¯è¨ˆç®—ä»€éº¼)",
                "default_code": "# ä½ çš„ç¨‹å¼ç¢¼...",
                "validation_keyword": "åŸ·è¡Œçµæœä¸­å¿…é ˆåŒ…å«çš„é—œéµå­— (ä¾‹å¦‚ 100 æˆ– Link Start)"
            }
            é¡Œç›®é›£åº¦ï¼šé©åˆå‰›å­¸è®Šæ•¸æˆ– print çš„åˆå­¸è€…ã€‚ç¹é«”ä¸­æ–‡ã€‚
            `;

            try {
                let jsonStr = await callGemini(prompt);
                // æ¸…ç† AI å¯èƒ½å›å‚³çš„ markdown ```json ... ```
                jsonStr = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const data = JSON.parse(jsonStr);
                
                // æ›´æ–°ä»‹é¢
                document.getElementById('m-title').innerText = data.title;
                document.getElementById('m-story').innerText = data.story;
                document.getElementById('m-task').innerText = data.task;
                document.getElementById('code').value = data.default_code;
                currentValidation = data.validation_keyword;
                
                addMsg('ai', `æ–°ä»»å‹™å·²ä¸‹é”ï¼š${data.title}ã€‚ç¥å¥½é‹ã€‚`);

            } catch(e) {
                console.error(e);
                addMsg('system', 'ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
            }
            
            btn.innerText = "ğŸ”„ ç”Ÿæˆæ–°æŒ‘æˆ°";
            btn.disabled = false;
        }

        // 3. æ²»ç™‚æ¨¡å¼
        async function triggerTherapy() {
            if(isTherapy) return;
            isTherapy = true;
            
            // é–å®šç•«é¢
            document.getElementById('therapy-overlay').style.display = 'flex';
            document.getElementById('editor-wrapper').style.filter = 'blur(10px)';
            document.getElementById('btn-resume').style.opacity = '0';

            const aiText = document.getElementById('ai-therapy-text');
            aiText.innerText = "AI æ­£åœ¨åˆ†ææ‚¨çš„ç²¾ç¥ç‹€æ…‹ä¸¦å°‹æ‰¾ç·©å’Œæ–¹æ¡ˆ...";

            // å‘¼å« Gemini å®‰æ’«
            const prompt = `
            å­¸ç”Ÿç¾åœ¨å£“åŠ›éå¤§ (Stress Level > 80%)ï¼Œç³»çµ±å·²å¼·åˆ¶æš«åœã€‚
            è«‹ä½ è¬›ä¸€å€‹ã€Œéå¸¸çŸ­çš„å†·ç¬‘è©±ã€æˆ–è€…ã€Œä¸€å¥æº«æš–çš„é¼“å‹µã€ã€‚
            èªæ°£è¦è¼•é¬†å¹½é»˜ï¼Œä¸è¦èªªæ•™ã€‚ç¹é«”ä¸­æ–‡ã€‚
            `;
            
            const reply = await callGemini(prompt);
            
            // æ‰“å­—æ©Ÿæ•ˆæœ
            let i = 0;
            aiText.innerHTML = "";
            const interval = setInterval(() => {
                aiText.innerHTML += reply.charAt(i);
                i++;
                if(i >= reply.length) {
                    clearInterval(interval);
                    document.getElementById('btn-resume').style.opacity = '1';
                }
            }, 50);
            
            // é‡ç½®å£“åŠ›
            stressScore = 40;
            textNegativeScore = 0;
            emoHistory = [];
        }

        function closeTherapy() {
            document.getElementById('therapy-overlay').style.display = 'none';
            document.getElementById('editor-wrapper').style.filter = 'none';
            isTherapy = false;
        }

        // --- é€šç”¨ API å‘¼å« ---
        async function callGemini(text) {
            if(API_KEY.includes("è«‹åœ¨æ­¤")) {
                alert("è«‹å¡«å…¥ API Keyï¼");
                return "API Key Error";
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text }] }] })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch(e) {
                return "é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
            }
        }

        // --- ğŸ’» Python åŸ·è¡Œä¿®æ­£ç‰ˆ ---
        async function runPythonCode() {
            const code = document.getElementById('code').value;
            const out = document.getElementById('output');
            
            out.innerText = ">>> åŸ·è¡Œä¸­...\n";

            if(!pyodide) {
                out.innerText += "Python ç’°å¢ƒå°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™ã€‚";
                return;
            }

            try {
                // é‡å° stdout
                pyodide.setStdout({
                    batched: (msg) => {
                        out.innerText += msg + "\n";
                    }
                });

                // åŸ·è¡Œ
                await pyodide.runPythonAsync(code);

                // ç°¡æ˜“é©—è­‰
                const result = out.innerText;
                if(currentValidation && result.includes(currentValidation)) {
                    out.innerText += `\n[SYSTEM]: âœ… ä»»å‹™ç›®æ¨™é”æˆï¼åµæ¸¬åˆ°é—œéµå­— "${currentValidation}"`;
                    addMsg('ai', 'å¹¹å¾—å¥½ï¼ä»£ç¢¼åŸ·è¡ŒæˆåŠŸã€‚ä»»å‹™å®Œæˆã€‚');
                } else if (currentValidation) {
                    out.innerText += `\n[SYSTEM]: âš ï¸ åŸ·è¡Œå®Œæˆï¼Œä½†æœªåµæ¸¬åˆ°é æœŸçµæœ "${currentValidation}"`;
                }

            } catch(err) {
                out.innerText += "\n[Error]: " + err;
                // å¦‚æœå‡ºéŒ¯ï¼Œå°‡éŒ¯èª¤è¨Šæ¯å·å·è¨˜ä¸‹ä¾†ï¼Œå¦‚æœå­¸ç”Ÿä¹‹å¾Œæ±‚æ•‘ï¼ŒAI å°±çŸ¥é“ç™¼ç”Ÿä»€éº¼äº‹
            }
        }

        // --- UI è¼”åŠ© ---
        function addMsg(role, html) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = html;
            const box = document.getElementById('chat-box');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

    </script>
</body>
</html>
