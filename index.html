<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus: å¤šæ¨¡æ…‹æ„ŸçŸ¥ç³»çµ± (v4.0 Omni)</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #0a0a0a;
            --panel-bg: #141414;
            --accent: #00e5ff; /* Cyber Blue */
            --danger: #ff2a2a;
            --border: #333;
        }

        body {
            background-color: var(--bg-color);
            color: #ddd;
            font-family: 'Segoe UI', monospace;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* å·¦å´ç›£æ§ */
        .panel-left {
            width: 320px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
            z-index: 10;
        }

        .cam-box {
            height: 200px;
            background: #000;
            border: 2px solid var(--accent);
            position: relative;
            margin-bottom: 10px;
            overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .metrics-box {
            background: #1f1f1f;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .val { color: var(--accent); font-weight: bold; }
        .val.bad { color: var(--danger); }

        /* å£“åŠ›æ¢ */
        .stress-container {
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        .stress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent);
            transition: width 0.3s, background 0.3s;
        }

        /* èŠå¤© */
        #chat-box {
            flex-grow: 1;
            background: #000;
            border: 1px solid var(--border);
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .msg { padding: 8px; border-radius: 4px; font-size: 0.9em; max-width: 90%; }
        .msg.ai { background: #222; border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.user { background: #005577; align-self: flex-end; }
        
        input { background: #222; border: 1px solid #444; color: white; padding: 10px; margin-top: 10px; }

        /* å³å´æ“ä½œ */
        .panel-right {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #editor-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            transition: filter 0.8s;
        }
        
        textarea {
            flex-grow: 1;
            background: #111;
            color: #0f0;
            border: none;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            resize: none;
            outline: none;
        }

        /* æ²»ç™‚æ¨¡å¼è¦†è“‹å±¤ */
        #therapy-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.95);
            z-index: 999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .therapy-box { width: 60%; padding: 40px; border: 2px solid var(--danger); border-radius: 10px; background: #1a1a1a; }
        
        #btn-resume {
            margin-top: 20px; padding: 10px 30px; 
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            cursor: pointer; opacity: 0; transition: opacity 1s;
        }

        /* é™¤éŒ¯è³‡è¨Š (å¯é¸éš±è—) */
        .debug-info { color: #555; font-size: 0.7em; margin-top: 5px; }

    </style>
</head>
<body>

    <div class="panel-left">
        <h3 style="color:var(--accent); text-align:center;">OMNI SENSE v4.0</h3>
        
        <div class="cam-box">
            <video id="video" autoplay muted playsinline></video>
        </div>

        <div class="metrics-box">
            <div class="metric-row">
                <span>æƒ…ç·’ (10s avg):</span>
                <span id="emo-val" class="val">--</span>
            </div>
            <div class="metric-row">
                <span>æœ€å¾Œè¼¸å…¥:</span>
                <span id="idle-val" class="val">0s</span>
            </div>
            <div class="metric-row">
                <span>æ»‘é¼ æ¸¸ç§»:</span>
                <span id="mouse-val" class="val">0</span>
            </div>
            
            <div style="margin-top:10px;">ç¶œåˆå£“åŠ›æŒ‡æ•¸ (Stress Index)</div>
            <div class="stress-container">
                <div id="stress-bar" class="stress-bar"></div>
            </div>
            <div id="debug-trigger" class="debug-info">ç‹€æ…‹: ç›£æ§ä¸­</div>
        </div>

        <div id="chat-box">
            <div class="msg ai">ç³»çµ±å·²å•Ÿå‹•ã€‚æ­£åœ¨é€²è¡Œå¤šæ¨¡æ…‹è¡Œç‚ºåˆ†æ...</div>
        </div>
        <input type="text" id="user-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') sendChat()">
    </div>

    <div class="panel-right">
        <!-- æ²»ç™‚æ¨¡å¼ -->
        <div id="therapy-overlay">
            <div class="therapy-box">
                <h1 style="color: var(--danger);">âš ï¸ æª¢æ¸¬åˆ°é«˜å£“åŠ›åæ‡‰</h1>
                <p style="color:#aaa;">åˆ¤æ–·ä¾æ“šï¼š<span id="trigger-reason"></span></p>
                <hr style="border-color:#333; margin:20px 0;">
                <div id="ai-therapy-text" style="font-size:1.2em; min-height:60px;">AI æ­£åœ¨é€£ç·š...</div>
                <button id="btn-resume" onclick="closeTherapy()">æˆ‘æº–å‚™å¥½äº†ï¼Œç¹¼çºŒ â–¶</button>
            </div>
        </div>

        <div style="margin-bottom:10px;">
            <h2 id="lvl-title">Level 1: è®Šæ•¸èˆ‡è³¦å€¼</h2>
            <p id="lvl-desc" style="color:#888;">è«‹å®šç¾©è®Šæ•¸ score ä¸¦è¨­ç‚º 100ã€‚</p>
        </div>

        <div id="editor-area">
            <textarea id="code" spellcheck="false" oninput="handleTyping()" onkeydown="handleKeyDown(event)"></textarea>
            <div style="padding:10px; background:#222; text-align:right;">
                <button onclick="runCode()" style="padding:8px 20px; background:var(--accent); border:none; cursor:pointer;">åŸ·è¡Œ (Run)</button>
            </div>
            <div id="output" style="height:100px; background:black; color:#aaa; padding:10px; font-family:monospace;"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”‘ API KEY è¨­å®š
        // ==========================================
        const API_KEY = "AIzaSyA2k88qSlo4mcuWkjoLBf9Yeb-v4BXgaco"; 
        const MODEL_NAME = "gemini-2.5-flash";
        // ==========================================

        // --- è®Šæ•¸èˆ‡ç‹€æ…‹ ---
        let pyodide = null;
        let isModelLoaded = false;
        let isTherapy = false;

        // 1. æƒ…ç·’æ»‘å‹•çª—å£ (Sliding Window)
        const WINDOW_SIZE = 20; // 20å€‹æ¨£æœ¬ (ç´„10ç§’ï¼Œæ¯0.5ç§’ä¸€æ¬¡)
        let emotionWindow = []; // å„²å­˜ 0(æ­£å‘) æˆ– 1(è² å‘)

        // 2. è¡Œç‚ºè¿½è¹¤
        let lastTypingTime = Date.now();
        let mouseDist = 0; // æ¯ç§’ç´¯ç©ç§»å‹•è·é›¢
        let backspaceCount = 0; // æ†¤æ€’åˆªé™¤è¨ˆæ•¸
        
        // 3. ç¶œåˆå£“åŠ›å€¼ (0-100)
        let stressScore = 0;

        // --- åˆå§‹åŒ– ---
        async function init() {
            try {
                pyodide = await loadPyodide();
                document.getElementById('output').innerText = "Python Ready.";
            } catch(e) {}

            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
            ]);
            isModelLoaded = true;

            const video = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            
            // å•Ÿå‹•å…©å€‹å¾ªç’°
            video.addEventListener('play', () => {
                setInterval(detectEmotion, 500); // 0.5ç§’ä¸€æ¬¡è¡¨æƒ…
                setInterval(analyzeBehavior, 1000); // 1ç§’ä¸€æ¬¡è¡Œç‚ºç¸½çµ
            });

            // æ»‘é¼ ç›£è½
            document.addEventListener('mousemove', (e) => {
                mouseDist += Math.abs(e.movementX) + Math.abs(e.movementY);
            });
        }
        init();

        // --- ğŸ§  æ ¸å¿ƒé‚è¼¯ A: è¡¨æƒ…æ»‘å‹•çª—å£ ---
        async function detectEmotion() {
            if(!isModelLoaded || isTherapy) return;
            const video = document.getElementById('video');
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            
            let isNegative = 0;
            let label = "Neutral";

            if(detections.length > 0) {
                const ex = detections[0].expressions;
                const sorted = Object.entries(ex).sort((a,b) => b[1]-a[1]);
                const topEmo = sorted[0][0];
                label = topEmo;

                // å®šç¾©è² é¢æƒ…ç·’
                if(['sad', 'angry', 'fearful', 'disgusted'].includes(topEmo)) {
                    isNegative = 1;
                }
            }

            // æ›´æ–°æ»‘å‹•çª—å£
            emotionWindow.push(isNegative);
            if(emotionWindow.length > WINDOW_SIZE) emotionWindow.shift(); // ç§»é™¤æœ€èˆŠçš„

            // UI æ›´æ–°
            const emoText = document.getElementById('emo-val');
            emoText.innerText = label;
            emoText.className = isNegative ? "val bad" : "val";
        }

        // --- ğŸ§  æ ¸å¿ƒé‚è¼¯ B: è¡Œç‚ºåˆ†æèˆ‡å£“åŠ›è¨ˆç®— ---
        function analyzeBehavior() {
            if(isTherapy) return;

            const now = Date.now();
            
            // 1. è¨ˆç®—è¡¨æƒ…è² é¢ç‡ (60% è¦å‰‡)
            const negCount = emotionWindow.reduce((a,b) => a+b, 0);
            const negRatio = emotionWindow.length > 0 ? negCount / emotionWindow.length : 0;

            // 2. è¨ˆç®—é–’ç½®æ™‚é–“ (ç§’)
            const idleSeconds = (now - lastTypingTime) / 1000;
            document.getElementById('idle-val').innerText = idleSeconds.toFixed(0) + "s";

            // 3. è¨ˆç®—æ»‘é¼ ç„¦æ…®åº¦ (å‡è¨­ > 1000 åƒç´ /ç§’ ä¸”æ²’æ‰“å­— = ç„¦æ…®éŠèµ°)
            const isMouseJitter = (mouseDist > 1000 && idleSeconds > 5);
            document.getElementById('mouse-val').innerText = mouseDist;
            mouseDist = 0; // é‡ç½®ä¸‹ä¸€ç§’çš„è¨ˆæ•¸

            // 4. è¨ˆç®—ç¶œåˆå£“åŠ› (æ¬Šé‡æ¼”ç®—æ³•)
            let newStress = 0;

            // å› ç´  A: è¡¨æƒ… (æ¬Šé‡é«˜)
            if (negRatio >= 0.6) newStress += 60; // åªè¦ 60% æ™‚é–“è‡‰è‡­ï¼ŒåŸºç¤å£“åŠ›å°±é«˜
            else if (negRatio >= 0.3) newStress += 30;

            // å› ç´  B: å¡é—œé–’ç½® (Idle > 20s)
            if (idleSeconds > 20) newStress += 20;

            // å› ç´  C: æ†¤æ€’åˆªé™¤ (Backspace Rage)
            if (backspaceCount > 5) newStress += 40; // ç¬é–“æš´å¢
            
            // å› ç´  D: ç„¦æ…®æ»‘é¼ 
            if (isMouseJitter) newStress += 15;

            // å¹³æ»‘éæ¸¡ (ä¸è¦ç¬é–“è·³å‹•å¤ªå¿«)
            stressScore = (stressScore * 0.7) + (newStress * 0.3);
            
            // æ¸…ç† Backspace è¨ˆæ•¸ (æ¯ç§’éæ¸›ï¼Œæ¨¡æ“¬å†·å»)
            if(backspaceCount > 0) backspaceCount--;

            updateStressUI();
        }

        function updateStressUI() {
            const bar = document.getElementById('stress-bar');
            bar.style.width = Math.min(100, stressScore) + "%";
            
            if(stressScore < 40) bar.style.background = "#00e5ff";
            else if(stressScore < 80) bar.style.background = "#ffaa00";
            else bar.style.background = "#ff2a2a";

            // è§¸ç™¼æ²»ç™‚æ¨¡å¼ (é–¾å€¼ 80)
            if(stressScore > 80) {
                let reasons = [];
                // åˆ¤æ–·ä¸»å› 
                const negRatio = emotionWindow.reduce((a,b) => a+b, 0) / emotionWindow.length;
                if(negRatio >= 0.6) reasons.push("æŒçºŒè² é¢è¡¨æƒ…");
                const idle = (Date.now() - lastTypingTime)/1000;
                if(idle > 20) reasons.push("é•·æ™‚é–“åœæ»¯");
                if(backspaceCount > 3) reasons.push("é »ç¹åˆªé™¤ä»£ç¢¼");
                
                triggerTherapy(reasons.join(" + "));
            }
        }

        // --- è¼¸å…¥ç›£è½ ---
        function handleTyping() {
            lastTypingTime = Date.now();
        }
        function handleKeyDown(e) {
            if(e.key === 'Backspace') {
                backspaceCount += 2; // æŒ‰ä¸€æ¬¡åŠ 2åˆ†
            }
        }

        // --- æ²»ç™‚æ¨¡å¼é‚è¼¯ ---
        async function triggerTherapy(reason) {
            isTherapy = true;
            document.getElementById('therapy-overlay').style.display = 'flex';
            document.getElementById('editor-area').style.filter = 'blur(10px)';
            document.getElementById('trigger-reason').innerText = reason || "ç¶œåˆå£“åŠ›éé«˜";
            document.getElementById('btn-resume').style.opacity = '0';

            const aiDiv = document.getElementById('ai-therapy-text');
            aiDiv.innerHTML = "AI æ­£åœ¨ç”Ÿæˆç·©å’Œæ–¹æ¡ˆ...";

            // å‘¼å« Gemini
            const prompt = `
            ä½¿ç”¨è€…æ­£åœ¨å­¸ç¿’å¯«ç¨‹å¼ï¼Œç³»çµ±åµæ¸¬åˆ°é«˜å£“åŠ›åæ‡‰ã€‚
            åŸå› ï¼š${reason}ã€‚
            è«‹ä½ æ‰®æ¼”ä¸€å€‹å¹½é»˜çš„ AI å¤¥ä¼´ï¼š
            1. å…ˆå°ä»–çš„ç‹€æ³è¡¨ç¤ºç†è§£ (ä¾‹å¦‚ï¼šçœ‹ä¾†é€™æ®µ Code å¾ˆé›£æ...)
            2. è¬›ä¸€å€‹è¶…ç´šçŸ­çš„å†·ç¬‘è©±ï¼Œæˆ–æ˜¯çµ¦ä¸€å€‹æ”¾é¬†çš„å°å»ºè­°ã€‚
            3. ä¸è¦æ•™ç¨‹å¼ç¢¼ï¼åªè¦è®“ä»–å¿ƒæƒ…è®Šå¥½ã€‚
            å­—æ•¸é™åˆ¶ 50 å­—ã€‚ç¹é«”ä¸­æ–‡ã€‚
            `;
            
            const reply = await callGemini(prompt);
            typeWriter(aiDiv, reply, () => {
                document.getElementById('btn-resume').style.opacity = '1';
            });
            
            // é‡ç½®å£“åŠ›å€¼ï¼Œé¿å…ä¸€å›ä¾†åˆé¦¬ä¸Šè§¸ç™¼
            stressScore = 30;
            emotionWindow = new Array(WINDOW_SIZE).fill(0); 
        }

        function closeTherapy() {
            document.getElementById('therapy-overlay').style.display = 'none';
            document.getElementById('editor-area').style.filter = 'none';
            isTherapy = false;
            lastTypingTime = Date.now(); // é‡ç½®é–’ç½®è¨ˆæ™‚
        }

        // --- Gemini API & Utils ---
        async function callGemini(text) {
            if(API_KEY.includes("è«‹åœ¨æ­¤")) return "è«‹è¨­å®š API Key";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            try {
                const res = await fetch(url, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text }] }] })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch(e) { return "é€£ç·šå¤±æ•—ï¼Œè«‹æ·±å‘¼å¸ã€‚"; }
        }

        async function sendChat() {
            const input = document.getElementById('user-input');
            const val = input.value;
            if(!val) return;
            
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div class="msg user">${val}</div>`;
            input.value = "";
            
            const code = document.getElementById('code').value;
            const reply = await callGemini(`å­¸ç”Ÿå•ï¼š${val}\nç¨‹å¼ç¢¼ï¼š${code}\nè«‹ç°¡çŸ­å›ç­”ã€‚`);
            box.innerHTML += `<div class="msg ai">${marked.parse(reply)}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function typeWriter(el, text, cb) {
            el.innerHTML = "";
            let i=0;
            const t = setInterval(() => {
                el.innerHTML += text.charAt(i);
                i++;
                if(i >= text.length) { clearInterval(t); if(cb) cb(); }
            }, 50);
        }

        async function runCode() {
            const out = document.getElementById('output');
            out.innerText = "Running...";
            try {
                let log = "";
                pyodide.setStdout({ batched: s => log += s + "\n" });
                await pyodide.runPythonAsync(document.getElementById('code').value);
                out.innerText = log;
            } catch(e) { out.innerText = e; }
        }
    </script>
</body>
</html>
