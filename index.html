<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus: AI æƒ…ç·’é˜²è­·ç³»çµ± (v3.0 Therapy)</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #111;
            --text-main: #e0e0e0;
            --accent: #00ff41; /* Matrix Green */
            --danger: #ff3333;
            --warning: #ffaa00;
            --border: #333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', 'Courier New', monospace;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- å·¦å´ç›£æ§é¢æ¿ --- */
        .panel-left {
            width: 300px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
            z-index: 10;
        }

        .cam-frame {
            border: 2px solid var(--accent);
            height: 200px;
            background: #000;
            position: relative;
            margin-bottom: 10px;
            overflow: hidden;
            border-radius: 4px;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .status-module {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border);
            margin-bottom: 10px;
        }
        
        .emotion-text { font-size: 1.2em; font-weight: bold; transition: 0.3s; }
        
        /* 10ç§’å€’æ•¸è­¦å‘Šæ¢ */
        .load-bar-container {
            height: 10px;
            background: #333;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
            position: relative;
        }
        .load-bar {
            height: 100%;
            width: 0%;
            background: var(--danger);
            transition: width 0.5s linear; /* å¹³æ»‘éæ¸¡ */
        }
        .load-text { font-size: 0.8em; color: #888; text-align: right; margin-top: 2px; }

        /* èŠå¤©å®¤ */
        #chat-box {
            flex-grow: 1;
            background: #000;
            border: 1px solid var(--border);
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 90%; font-size: 0.9em; line-height: 1.5; }
        .msg.ai { background: #222; border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.user { background: #004400; align-self: flex-end; }
        .msg.system { text-align: center; color: #666; font-size: 0.8em; }

        input {
            background: #111; border: 1px solid #444; color: white; padding: 10px; width: 100%; box-sizing: border-box;
        }

        /* --- å³å´æ“ä½œå€ --- */
        .panel-right {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .mission-header {
            border-left: 4px solid var(--accent);
            padding-left: 15px;
            margin-bottom: 20px;
        }
        
        #editor-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            border-radius: 5px;
            overflow: hidden;
            transition: filter 0.8s; /* æ¨¡ç³Šå‹•ç•« */
        }
        
        textarea {
            flex-grow: 1;
            background: #0d0d0d;
            color: #ddd;
            border: none;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            resize: none;
            outline: none;
        }

        .controls {
            padding: 10px;
            background: #1a1a1a;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        button {
            padding: 8px 24px;
            background: var(--accent);
            color: black;
            border: none;
            font-weight: bold;
            cursor: pointer;
            border-radius: 3px;
        }
        button:hover { opacity: 0.8; }
        button.next { background: #00aaff; color: white; display: none; }

        #output {
            height: 120px;
            background: black;
            color: #aaa;
            padding: 10px;
            font-family: monospace;
            border-top: 1px solid var(--border);
            white-space: pre-wrap;
        }

        /* --- ğŸš¨ å¼·åˆ¶ä»‹å…¥è¦†è“‹å±¤ (Therapy Overlay) --- */
        #therapy-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 999;
            display: none; /* é è¨­éš±è— */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            animation: fadeIn 1s;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .therapy-card {
            width: 60%;
            max-width: 600px;
            background: #111;
            border: 2px solid var(--accent);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(0, 255, 65, 0.2);
        }

        .therapy-icon { font-size: 3em; margin-bottom: 20px; }
        
        #ai-therapy-msg {
            font-size: 1.2em;
            color: #fff;
            margin: 20px 0;
            line-height: 1.6;
            min-height: 80px;
        }

        .btn-resume {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 10px 30px;
            margin-top: 20px;
            opacity: 0; /* ä¸€é–‹å§‹éš±è—ï¼Œç­‰ AIè¬›å®Œè©±æ‰å‡ºä¾† */
            transition: opacity 1s;
        }

    </style>
</head>
<body>

    <!-- å·¦å´ -->
    <div class="panel-left">
        <h2 style="color:var(--accent); text-align:center; letter-spacing:2px;">NEXUS OS</h2>
        
        <div class="cam-frame">
            <video id="video" autoplay muted playsinline></video>
        </div>

        <div class="status-module">
            <div>æƒ…ç·’æƒæ: <span id="emotion-val" class="emotion-text">åˆå§‹åŒ–...</span></div>
            
            <!-- 10ç§’ç´¯ç©æ¢ -->
            <div style="margin-top: 15px; font-size: 0.8em; color: gray; display: flex; justify-content: space-between;">
                <span>MENTAL LOAD (æƒ…ç·’è² è¼‰)</span>
                <span id="timer-val">0s</span>
            </div>
            <div class="load-bar-container">
                <div id="stress-bar" class="load-bar"></div>
            </div>
        </div>

        <div id="chat-box">
            <div class="msg ai">ç³»çµ±å°±ç·’ã€‚æ”å½±æ©Ÿç›£æ§ä¸­...<br>è‹¥åµæ¸¬åˆ°æƒ…ç·’éè¼‰ï¼Œå°‡è‡ªå‹•å•Ÿå‹•å®‰å…¨å”è­°ã€‚</div>
        </div>
        
        <input type="text" id="user-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') askAI()">
    </div>

    <!-- å³å´ -->
    <div class="panel-right">
        
        <!-- ğŸš¨ æ²»ç™‚æ¨¡å¼è¦†è“‹å±¤ -->
        <div id="therapy-layer">
            <div class="therapy-card">
                <div class="therapy-icon">â˜•</div>
                <h2 style="color: var(--accent);">ç³»çµ±æš«åœ // System Paused</h2>
                <p style="color: #888;">åµæ¸¬åˆ°æŒçºŒæ€§çš„è² é¢æƒ…ç·’ (è¶…é10ç§’)ã€‚<br>ç‚ºäº†å­¸ç¿’æ•ˆç‡ï¼Œè«‹æš«æ™‚æ”¾ä¸‹ç¨‹å¼ç¢¼ã€‚</p>
                <hr style="border-color: #333; margin: 20px 0;">
                
                <!-- AI çš„å®‰æ’«è¨Šæ¯æœƒæ‰“å­—é¡¯ç¤ºåœ¨é€™è£¡ -->
                <div id="ai-therapy-msg">AI æ­£åœ¨æ€è€ƒå¦‚ä½•è®“ä½ é–‹å¿ƒ...</div>
                
                <button id="btn-resume" class="btn-resume" onclick="closeTherapy()">
                    æˆ‘æ„Ÿè¦ºå¥½å¤šäº†ï¼Œç¹¼çºŒå­¸ç¿’ â–¶
                </button>
            </div>
        </div>

        <div class="mission-header">
            <h1 id="lvl-title">Level 1: Hello Nexus</h1>
            <p id="lvl-desc" style="color:#aaa;">è«‹å°å‡º "Hello World" ä»¥æ¸¬è©¦é€šè¨Šã€‚</p>
        </div>

        <div id="editor-area">
            <textarea id="code" spellcheck="false"></textarea>
            <div class="controls">
                <button onclick="runCode()">åŸ·è¡Œä»£ç¢¼ (RUN)</button>
                <button id="btn-next" class="next" onclick="nextLevel()">ä¸‹ä¸€é—œ â”</button>
            </div>
            <div id="output">ç­‰å¾…æŒ‡ä»¤...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”‘ API KEY è¨­å®š
        // ==========================================
        const API_KEY = "è«‹åœ¨æ­¤å¡«å…¥ä½ çš„å…¨æ–°API_KEY"; 
        
        // æŒ‡å®šä½¿ç”¨ 1.5 Flash (ç›®å‰æœ€å¿«ä¸”ç©©å®š)
        const MODEL_NAME = "gemini-1.5-flash"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        // ==========================================

        // ç‹€æ…‹è®Šæ•¸
        let pyodide = null;
        let isModelLoaded = false;
        let isTherapyMode = false;
        
        // ğŸš¨ æ ¸å¿ƒè¨ˆæ™‚é‚è¼¯
        let negativeTimeMs = 0; // ç´¯ç©æ¯«ç§’æ•¸
        const THRESHOLD_MS = 10000; // 10ç§’è§¸ç™¼
        const CHECK_INTERVAL = 500; // æ¯0.5ç§’æª¢æŸ¥ä¸€æ¬¡

        // é—œå¡
        const levels = [
            { 
                t: "Level 1: è¨Šè™Ÿé€£çµ", 
                d: "é§­å®¢çš„ç¬¬ä¸€æ­¥ã€‚è«‹ä½¿ç”¨ print() å°å‡º 'Hello Nexus'ã€‚", 
                c: "print('Hello World')", 
                check: (o) => o.includes("Hello Nexus") 
            },
            { 
                t: "Level 2: è®Šæ•¸å„²å­˜", 
                d: "å®šç¾©ä¸€å€‹è®Šæ•¸ x ä¸¦è¨­ç‚º 10ï¼Œç„¶å¾Œå°å‡ºå®ƒã€‚", 
                c: "# å®šç¾©è®Šæ•¸ x\n", 
                check: (o) => o.trim() == "10" 
            },
            { 
                t: "Level 3: è¿´åœˆé¢¨æš´", 
                d: "ä½¿ç”¨ while è¿´åœˆå¾ 5 å€’æ•¸åˆ° 1ã€‚", 
                c: "count = 5\nwhile count > 0:\n    print(count)\n    # è¨˜å¾—æ¸› 1", 
                check: (o) => o.includes("5") && o.includes("1") 
            }
        ];
        let currLvl = 0;

        // åˆå§‹åŒ–
        async function init() {
            // Python
            try {
                pyodide = await loadPyodide();
                document.getElementById('output').innerText = "Python æ ¸å¿ƒå·²è¼‰å…¥ã€‚";
            } catch(e) { console.error(e); }

            // Face API
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
            ]);
            isModelLoaded = true;
            document.getElementById('emotion-val').innerText = "åµæ¸¬ä¸­...";

            // Webcam
            const video = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            
            video.addEventListener('play', () => {
                setInterval(detectLoop, CHECK_INTERVAL);
            });

            loadLevel(0);
        }
        init();

        // ğŸ¯ æ ¸å¿ƒï¼šæƒ…ç·’åµæ¸¬èˆ‡è¨ˆæ™‚é‚è¼¯
        async function detectLoop() {
            if(!isModelLoaded || isTherapyMode) return; // æ²»ç™‚ä¸­ä¸ç¹¼çºŒç´¯ç©

            const video = document.getElementById('video');
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();

            if(detections.length > 0) {
                const ex = detections[0].expressions;
                const sorted = Object.entries(ex).sort((a,b) => b[1]-a[1]);
                const emotion = sorted[0][0]; // happy, sad, neutral...

                updateUI(emotion);
                handleStressTimer(emotion);
            }
        }

        // é‚è¼¯ï¼šè™•ç† 10 ç§’ç´¯ç©
        function handleStressTimer(emotion) {
            const badEmotions = ['sad', 'angry', 'fearful', 'disgusted'];
            
            if (badEmotions.includes(emotion)) {
                // ç´¯ç©æ™‚é–“
                negativeTimeMs += CHECK_INTERVAL;
            } else if (emotion === 'happy') {
                // é–‹å¿ƒæœƒå¿«é€Ÿæ¶ˆé™¤å£“åŠ›
                negativeTimeMs = Math.max(0, negativeTimeMs - 2000); 
            } else {
                // å¹³éœæœƒç·©æ…¢æ¶ˆé™¤
                negativeTimeMs = Math.max(0, negativeTimeMs - 500);
            }

            // æ›´æ–° UI é€²åº¦æ¢
            const percent = Math.min(100, (negativeTimeMs / THRESHOLD_MS) * 100);
            document.getElementById('stress-bar').style.width = percent + "%";
            document.getElementById('timer-val').innerText = (negativeTimeMs/1000).toFixed(1) + "s";

            // è§¸ç™¼æ¢ä»¶ï¼šè¶…é 10 ç§’
            if (negativeTimeMs >= THRESHOLD_MS) {
                activateTherapyMode();
            }
        }

        function updateUI(emotion) {
            const el = document.getElementById('emotion-val');
            const map = {
                'happy': { t:'è‡ªä¿¡ (Flow)', c:'#00ff41' },
                'neutral': { t:'å°ˆæ³¨', c:'#00ffff' },
                'sad': { t:'æŒ«æŠ˜', c:'#ff3333' },
                'angry': { t:'ç„¦æ…®', c:'#ff3333' }
            };
            const s = map[emotion] || {t:emotion, c:'#fff'};
            el.innerText = s.t;
            el.style.color = s.c;
        }

        // ğŸš¨ å•Ÿå‹•æ²»ç™‚æ¨¡å¼
        async function activateTherapyMode() {
            isTherapyMode = true;
            negativeTimeMs = 0; // é‡ç½®è¨ˆæ™‚å™¨
            document.getElementById('stress-bar').style.width = "0%";

            // UI è®ŠåŒ–
            document.getElementById('therapy-layer').style.display = 'flex';
            document.getElementById('editor-area').style.filter = 'blur(10px)'; // æ¨¡ç³ŠèƒŒæ™¯
            document.getElementById('btn-resume').style.opacity = '0'; // å…ˆéš±è—æŒ‰éˆ•

            // å‘¼å« AI (Gemini)
            const therapyMsgDiv = document.getElementById('ai-therapy-msg');
            therapyMsgDiv.innerHTML = "ğŸ’¡ AI æ­£åœ¨åˆ†æç·©è§£ç„¦æ…®çš„æœ€ä½³ç­–ç•¥...";

            const prompt = `
            æƒ…æ³ï¼šä¸€åæ­£åœ¨å­¸ç¿’ Python çš„å­¸ç”Ÿå·²ç¶“é€£çºŒæŒ«æŠ˜è¶…é 10 ç§’ï¼Œç³»çµ±å¼·åˆ¶æš«åœäº†å­¸ç¿’ã€‚
            ä»»å‹™ï¼šè«‹ä½ æ‰®æ¼”ä¸€ä½å¹½é»˜ã€æº«æš–çš„æœ‹å‹ï¼Œè¬›ä¸€å€‹çŸ­ç¬‘è©±ï¼Œæˆ–è€…å¼•å°ä»–åšä¸€æ¬¡æ·±å‘¼å¸ã€‚
            é™åˆ¶ï¼šä¸è¦æç¨‹å¼ç¢¼ï¼ä¸è¦èªªæ•™ï¼å­—æ•¸ 60 å­—ä»¥å…§ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ã€‚
            `;

            try {
                const text = await fetchGemini(prompt);
                
                // æ‰“å­—æ©Ÿæ•ˆæœé¡¯ç¤º AI å›è¦†
                typeWriterEffect(therapyMsgDiv, text, () => {
                    // è¬›å®Œè©±å¾Œï¼Œé¡¯ç¤ºã€Œç¹¼çºŒã€æŒ‰éˆ•
                    document.getElementById('btn-resume').style.opacity = '1';
                    document.getElementById('btn-resume').style.cursor = 'pointer';
                });

            } catch(e) {
                therapyMsgDiv.innerText = "æ·±å‘¼å¸... ä¼‘æ¯ä¸€ä¸‹å†å›ä¾†ã€‚";
                document.getElementById('btn-resume').style.opacity = '1';
            }
        }

        function closeTherapy() {
            document.getElementById('therapy-layer').style.display = 'none';
            document.getElementById('editor-area').style.filter = 'none';
            isTherapyMode = false;
            addMsg('system', 'ç³»çµ±æ¢å¾©ã€‚è«‹ä¾ç…§æ‚¨çš„æ­¥èª¿ç¹¼çºŒã€‚');
        }

        // --- Gemini API ---
        async function askAI() {
            const input = document.getElementById('user-input');
            const txt = input.value;
            if(!txt) return;
            
            addMsg('user', txt);
            input.value = '';
            
            const code = document.getElementById('code').value;
            const prompt = `
            ä½ æ˜¯ Code Nexus çš„ AI å°å¸«ã€‚
            ç•¶å‰é—œå¡ï¼š${levels[currLvl].t}
            å­¸ç”Ÿç¨‹å¼ç¢¼ï¼š${code}
            å­¸ç”Ÿå•é¡Œï¼š${txt}
            è«‹ç”¨ç¹é«”ä¸­æ–‡ç°¡çŸ­å›ç­”ã€‚
            `;
            
            addMsg('ai', '...');
            const reply = await fetchGemini(prompt);
            // ç§»é™¤æœ€å¾Œä¸€å€‹ ... è¨Šæ¯
            document.querySelector('#chat-box .msg:last-child').remove();
            addMsg('ai', marked.parse(reply));
        }

        async function fetchGemini(prompt) {
            if(API_KEY.includes("è«‹åœ¨æ­¤")) {
                alert("è«‹å¡«å…¥ API Key");
                return "API Key Error";
            }
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch(e) {
                console.error(e);
                return "é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯ã€‚";
            }
        }

        // --- è¼”åŠ©åŠŸèƒ½ ---
        function typeWriterEffect(element, text, callback) {
            element.innerHTML = "";
            let i = 0;
            const speed = 50; 
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else if (callback) {
                    callback();
                }
            }
            type();
        }

        async function runCode() {
            const code = document.getElementById('code').value;
            const out = document.getElementById('output');
            out.innerText = "åŸ·è¡Œä¸­...";
            try {
                let log = "";
                pyodide.setStdout({ batched: (s) => log += s + "\n" });
                await pyodide.runPythonAsync(code);
                out.innerText = log;
                
                if(levels[currLvl].check(log)) {
                    out.innerText += "\nâœ… é€šé—œæˆåŠŸï¼";
                    document.getElementById('btn-next').style.display = 'inline-block';
                }
            } catch(e) {
                out.innerText = "éŒ¯èª¤:\n" + e;
            }
        }

        function nextLevel() {
            if(currLvl < levels.length-1) {
                currLvl++;
                loadLevel(currLvl);
            } else {
                alert("æ­å–œå®Œæˆæ‰€æœ‰è¨“ç·´ï¼");
            }
        }

        function loadLevel(i) {
            document.getElementById('lvl-title').innerText = levels[i].t;
            document.getElementById('lvl-desc').innerText = levels[i].d;
            document.getElementById('code').value = levels[i].c;
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('output').innerText = "";
        }

        function addMsg(role, html) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = html;
            const box = document.getElementById('chat-box');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
